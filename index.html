<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; background: #f7f7f7; }
    .leaflet-tooltip {
      font-family: "Book Antiqua", serif;
      font-size: 13px;
      font-weight: bold;
      color: #000;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      padding: 4px 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ------------------ Configuración básica ------------------
    const map = L.map('map', {
      center: [-35.6751, -71.5430],
      zoom: 5,
      worldCopyJump: false,
      zoomControl: true
    });

    // Sin cartografía base (fondo neutro)
    document.getElementById('map').style.background = "#f7f7f7";

    // Rutas base (ajusta si los JSON están en otra carpeta)
    const BASE = "https://raw.githubusercontent.com/crcofre/mapa-apellidos/main";

    // Estilos de cada capa
    const styleRegiones = { color: "#0057b7", weight: 3.5, fillOpacity: 0.1 }; // azul
    const styleProvincias = { color: "#333", weight: 1, fillColor: "#76c893", fillOpacity: 0.55 };
    const styleComunas = { color: "#990000", weight: 0.8, fillColor: "#e34a33", fillOpacity: 0.45 };

    // Crear panes para controlar el orden de dibujo
    map.createPane('pane-provincias');  map.getPane('pane-provincias').style.zIndex = 520;
    map.createPane('pane-comunas');     map.getPane('pane-comunas').style.zIndex = 600;
    map.createPane('pane-regiones');    map.getPane('pane-regiones').style.zIndex = 650; // regiones arriba de todo

    // Grupos de capas
    const provinciasLayer = L.layerGroup().addTo(map);
    const comunasLayer = L.layerGroup();
    const regionesLayer = L.layerGroup().addTo(map);
    let comunasGeoLayer = null;

    // Función para obtener propiedades con nombre variable
    function getProp(p, keys, fallback = "—") {
      for (const k of keys) if (p && p[k] != null && p[k] !== "") return p[k];
      return fallback;
    }

    // ------------------ Carga de REGIONES ------------------
    fetch(`${BASE}/regiones.json`)
      .then(r => r.json())
      .then(geo => {
        L.geoJSON(geo, {
          pane: 'pane-regiones',
          style: styleRegiones,
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const reg = getProp(p, ["REGION", "NOM_REG", "Región", "NAME_1"], "Región");
            layer.bindTooltip(reg, { permanent: false, direction: 'auto', opacity: 0.95, sticky: true });
            layer.on('click', () => map.fitBounds(layer.getBounds(), { padding: [20, 20] }));
          }
        }).addTo(regionesLayer);
      });

    // ------------------ Carga de PROVINCIAS ------------------
    fetch(`${BASE}/provincias.json`)
      .then(r => r.json())
      .then(geo => {
        L.geoJSON(geo, {
          pane: 'pane-provincias',
          style: styleProvincias,
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const prov = getProp(p, ["PROVINCIA", "NOM_PROV", "Provincia", "NAME_2", "name"], "Provincia");
            layer.bindTooltip(prov, { permanent: false, direction: 'auto', opacity: 0.95, sticky: true });
            layer.on('click', () => map.fitBounds(layer.getBounds(), { padding: [20, 20] }));
            layer.on('mouseover', () => layer.setStyle({ fillOpacity: 0.65 }));
            layer.on('mouseout', () => layer.setStyle({ fillOpacity: 0.55 }));
          }
        }).addTo(provinciasLayer);
      });

    // ------------------ Carga de COMUNAS ------------------
    fetch(`${BASE}/comunas.json`)
      .then(r => r.json())
      .then(geo => {
        comunasGeoLayer = L.geoJSON(geo, {
          pane: 'pane-comunas',
          style: styleComunas,
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const com = getProp(p, ["COMUNA", "NOM_COM", "Comuna", "name"], "Comuna");
            layer.bindTooltip(com, { permanent: false, direction: 'auto', opacity: 0.95, sticky: true });
            layer.on('click', () => map.fitBounds(layer.getBounds(), { padding: [20, 20] }));
            layer.on('mouseover', () => layer.setStyle({ fillOpacity: 0.55 }));
            layer.on('mouseout', () => layer.setStyle({ fillOpacity: 0.45 }));
          }
        });
        updateComunasVisibility();
      });

    // ------------------ Mostrar comunas al acercar ------------------
    const ZOOM_MIN_COMUNAS = 8;
    function updateComunasVisibility() {
      if (!comunasGeoLayer) return;
      if (map.getZoom() >= ZOOM_MIN_COMUNAS) {
        if (!map.hasLayer(comunasLayer)) comunasLayer.addTo(map);
        if (!comunasLayer.hasLayer(comunasGeoLayer)) comunasGeoLayer.addTo(comunasLayer);
      } else {
        if (comunasLayer.hasLayer(comunasGeoLayer)) comunasLayer.removeLayer(comunasGeoLayer);
        if (map.hasLayer(comunasLayer)) map.removeLayer(comunasLayer);
      }
    }
    map.on('zoomend', updateComunasVisibility);

    // Control opcional de capas (puedes quitarlo si no quieres el panel)
    L.control.layers(null, {
      "Regiones (azul)": regionesLayer,
      "Provincias (verde)": provinciasLayer,
      "Comunas (rojo, zoom≥8)": comunasLayer
    }, { collapsed: true }).addTo(map);
  </script>
</body>
</html>
