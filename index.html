<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile (debug)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; background:#f7f7f7; }
    .ui{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#ffffffeb; backdrop-filter: blur(3px);
      border:1px solid #ddd; border-radius:10px; padding:10px 12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      max-width:min(92vw, 460px);
    }
    .ui h3{ margin:0 0 6px 0; font-size:14px; font-weight:700; }
    .ui .row{ display:flex; gap:6px; }
    .ui input{ flex:1; padding:6px 8px; font-size:14px; border:1px solid #ccc; border-radius:8px; }
    .ui button{ padding:6px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:600; background:#0b5ed7; color:#fff; }
    .ui small{ display:block; margin-top:6px; color:#555; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .legend{
      line-height:16px; color:#333; background:#fff; padding:8px 10px;
      border-radius:8px; border:1px solid #ddd; box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; font-size:12px;
    }
    .legend .item{ display:flex; align-items:center; gap:6px; }
    .legend .swatch{ width:18px; height:12px; border:1px solid #999; }

    .debug{
      margin-top:8px; font-size:12px; background:#fff; border:1px dashed #aaa; border-radius:8px; padding:8px;
      max-height:160px; overflow:auto; color:#333;
    }
    .debug b{ color:#000; }
    .debug .line{ margin:2px 0; }
    .warn{ color:#b36b00; }
    .err{ color:#b00000; font-weight:600; }
  </style>
</head>
<body>
  <div class="ui">
    <h3>Consulta tu apellido</h3>
    <div class="row">
      <input id="apellidoInput" type="text" placeholder="Ej.: Cisternas" list="apellidosList" autocomplete="off"/>
      <button id="btn-buscar">Buscar</button>
    </div>
    <datalist id="apellidosList"></datalist>
    <small id="estado">Cargando…</small>
    <div class="debug" id="debug"></div>
  </div>

  <div id="map"></div>

  <script>
    // ============= UTILIDAD DE LOG =============
    const dbgEl = document.getElementById('debug');
    function dlog(msg, kind="log", obj){
      const ts = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = 'line ' + (kind==="warn" ? "warn": kind==="error" ? "err" : "");
      div.textContent = `[${ts}] ${msg}`;
      dbgEl.appendChild(div);
      dbgEl.scrollTop = dbgEl.scrollHeight;
      if (kind==="warn") console.warn(msg, obj ?? "");
      else if (kind==="error") console.error(msg, obj ?? "");
      else console.log(msg, obj ?? "");
    }
    function setEstado(t){ document.getElementById('estado').textContent = t; dlog(`ESTADO: ${t}`); }

   <script>
  // ===== CAPTURA CUALQUIER ERROR GLOBAL =====
  (function() {
    const dbg = document.getElementById('debug');
    function line(msg, cls){ if(!dbg) return; const d=document.createElement('div'); d.className='line '+(cls||''); d.textContent=msg; dbg.appendChild(d); dbg.scrollTop=dbg.scrollHeight; }
    window.addEventListener('error', e => { console.error('GLOBAL ERROR', e); line('[GLOBAL ERROR] '+(e.message||e.error), 'err'); });
    window.addEventListener('unhandledrejection', e => { console.error('PROMISE REJECTION', e.reason); line('[PROMISE REJECTION] '+(e.reason&&e.reason.message?e.reason.message:e.reason), 'err'); });
    window.__dbgline = line; // util global para otros logs
  })();

  // ===== RUTAS FIJAS (evitamos auto-detección) =====
  const SITE_BASE = "https://crcofre.github.io/mapa-apellidos";   // << fijo
  const MANIFEST_URL = `${SITE_BASE}/data/apellidos_manifest.json`;
  const SHARDS_BASE  = `${SITE_BASE}/data/`;                      // tus shards están en /data
  const INDEX_URL    = `${SITE_BASE}/data/index_apellidos.json`;

  const GEO_REG = `${SITE_BASE}/regiones.json`;
  const GEO_PRO = `${SITE_BASE}/provincias.json`;
  const GEO_COM = `${SITE_BASE}/comunas.json`;

  // ===== LOG INICIAL PARA VERIFICAR =====
  (function(){
    console.log('RUTAS', {SITE_BASE, MANIFEST_URL, SHARDS_BASE, INDEX_URL, GEO_REG, GEO_PRO, GEO_COM});
    if (window.__dbgline) window.__dbgline('RUTAS OK: ' + JSON.stringify({MANIFEST_URL, INDEX_URL}));
  })();
</script>
<script>
let MANIFEST = null, INDICE = [];

async function boot(){
  try{
    if (window.__dbgline) window.__dbgline('boot() → cargando índice…');
    const idxRes = await fetch(INDEX_URL, {cache:'no-store'});
    console.log('fetch index_apellidos.json →', idxRes.status, idxRes.statusText);
    if (!idxRes.ok) throw new Error("No pude cargar index_apellidos.json");
    INDICE = await idxRes.json();

    // Generar manifest en cliente: apellidos_{dos letras}.json
    MANIFEST = {};
    for (const it of INDICE){
      const slug = String(it.slug||'').toLowerCase();
      const pref = (slug.slice(0,2) || '__');
      MANIFEST[slug] = `apellidos_${pref}.json`;
    }
    if (window.__dbgline) window.__dbgline('boot() → índice OK, manifest generado ('+Object.keys(MANIFEST).length+' slugs)');

    // autocompletar
    const dl = document.getElementById('apellidosList');
    dl.innerHTML = INDICE.map(x=>`<option value="${x.apellido}"></option>`).join('');
    document.getElementById('estado').textContent = "Listo. Escribe tu apellido y presiona Buscar.";
  }catch(err){
    console.error('boot() error', err);
    if (window.__dbgline) window.__dbgline('boot() ERROR: ' + (err.message||err), 'err');
    document.getElementById('estado').textContent = "No pude cargar el índice / generar manifest.";
  }
}

// Arranque explícito cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
  if (window.__dbgline) window.__dbgline('DOMContentLoaded → iniciar boot()');
  try { boot(); } catch (e) {
    console.error('Fallo al iniciar boot', e);
    if (window.__dbgline) window.__dbgline('Fallo al iniciar boot: '+(e.message||e), 'err');
  }
});
</script>



    // ====== Cargar un apellido desde su shard ======
    function slugify(s){
      return String(s ?? "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim().toLowerCase()
        .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    }

    async function cargarApellido(apellidoTexto){
      dlog(`cargarApellido("${apellidoTexto}")`);
      const slug = (INDICE.find(x => x.apellido.toUpperCase()===String(apellidoTexto).toUpperCase())?.slug) || slugify(apellidoTexto);
      dlog(`slug resuelto: ${slug}`);
      const shardName = MANIFEST?.[slug] || MANIFEST?.[slug.toLowerCase()];
      if (!shardName) throw new Error(`Apellido no disponible (manifest no tiene slug: ${slug}).`);

      const url = SHARDS_BASE + shardName;
      dlog(`fetch shard: ${url}`);
      const res = await fetch(url);
      dlog(`respuesta shard: ${res.status} ${res.statusText}`);
      if (!res.ok) throw new Error(`No pude leer shard ${shardName} (${res.status}).`);

      const shardData = await res.json();
      const data = shardData[slug] || shardData[slug.toLowerCase()] || shardData[slug.toUpperCase()];
      if (!data) throw new Error(`No encontré el apellido "${slug}" dentro de ${shardName}.`);
      dlog(`OK apellido "${data.apellido}" con ${data.comunas?.length||0} filas.`);
      return data;
    }

    // ====== Pintado ======
    function construirTablasValor(data){
      const reg = {}, prov = {}, com = {};
      for (const r of data.comunas || []){
        com[norm(r.comuna)] = r.prct_apellido ?? 0;
        const kProv = norm(r.provincia);
        const kReg  = norm(r.region);
        if (r.freq_prov!=null && !(kProv in prov)) prov[kProv] = r.freq_prov;
        if (r.freq_reg !=null && !(kReg  in reg )) reg[kReg ] = r.freq_reg;
      }
      return {reg, prov, com};
    }
    function valorFeature(f, nivel, tablas){
      const p = f.properties || {};
      if (nivel==="region"){
        const key = norm(getProp(p,["REGION","NOM_REG","Región","NAME_1"],""));
        return tablas.reg[key];
      }else if (nivel==="provincia"){
        const key = norm(getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],""));
        return tablas.prov[key];
      }else{
        const key = norm(getProp(p,["COMUNA","NOM_COM","Comuna","name"],""));
        return tablas.com[key];
      }
    }
    function pintar(data){
      window.__ultimo = data;
      const tablas = construirTablasValor(data);
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const pctFmt = v => (v==null || isNaN(v)) ? "0%" : `${(+v).toFixed(2).replace('.',',')}%`;

      const pintarCapa = (geo, nivel) => {
        if (!geo) { dlog(`No hay geo para ${nivel}`, "warn"); return; }
        geo.eachLayer(l=>{
          const v = valorFeature(l.feature, nivel, tablas);
          l.setStyle({ fillColor: colorByBins(v, pal, bins), fillOpacity:.65 });
          const p=l.feature.properties||{};
          const nombre = (nivel==="region")
            ? getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región")
            : (nivel==="provincia")
              ? getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia")
              : getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          l.bindTooltip(`${nombre}<br><small>${data.apellido}: <b>${pctFmt(v)}</b></small>`, {sticky:true,opacity:.95});
        });
      };

      const z = map.getZoom();
      if (z <= 6) pintarCapa(regionesGeo,"region");
      else if (z <= 7) pintarCapa(provinciasGeo,"provincia");
      else pintarCapa(comunasGeo,"comuna");

      setEstado(`Mostrando "${data.apellido}" (${nivelActual}).`);
    }

    // ====== UI ======
    async function onBuscar(){
      const v = document.getElementById('apellidoInput').value.trim();
      if (!v) return;
      setEstado(`Cargando "${v}"…`);
      try{
        const data = await cargarApellido(v);
        pintar(data);
      }catch(e){
        setEstado(e.message);
        dlog(e.message, "error", e);
      }
    }
    document.getElementById('btn-buscar').addEventListener('click', onBuscar);
    document.getElementById('apellidoInput').addEventListener('keydown', e=>{ if(e.key==="Enter") onBuscar(); });

    // ====== Inicio ======
    (async function start(){
      setEstado("Cargando manifest, índice y GeoJSON…");
      await boot(); // manifest + index
      // geojson se carga en paralelo al inicio; si ya terminó, updateVisibility() habrá corrido
      dlog("Boot completado.");
    })();
  </script>
</body>
</html>
