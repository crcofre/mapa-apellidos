<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Apellido – Comunas de Chile</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  #app{display:grid;grid-template-rows:auto auto 1fr auto;min-height:100vh}
  header{padding:.75rem 1rem;background:#fff;border-bottom:1px solid #eee}
  h1{font-size:1.05rem;margin:0}
  #controls{display:flex;gap:.75rem;align-items:center;margin-top:.45rem;flex-wrap:wrap}
  label{font-size:.9rem;color:#374151}
  input,button{padding:.35rem .55rem;border:1px solid #e5e7eb;border-radius:.5rem}
  input{min-width:320px;max-width:100%}
  button{cursor:pointer;background:#fff}
  #status{padding:.45rem 1rem;background:#f8fafc;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;font-size:.9rem;color:#374151}
  #map{height:70vh;min-height:560px;background:#000 !important}
  .legend{background:#fff;padding:.5rem .6rem;line-height:1.2;border-radius:.5rem;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:.85rem}
  .legend .scale{display:flex;gap:4px;align-items:center;margin:.18rem 0}
  .legend .swatch{width:18px;height:12px;border-radius:2px}
  .legend .label{margin-left:.35rem;white-space:nowrap}
  .info{padding:.5rem .6rem;background:#fff;border-radius:.5rem;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:.9rem}
  footer{padding:.55rem 1rem;font-size:.85rem;color:#ccc;background:#000;border-top:1px solid #222}
  .pill{background:#ef4444;color:#fff;padding:.12rem .45rem;border-radius:999px;font-size:.8rem}
  .ok{color:#10b981}.err{color:#ef4444}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>Apellido <span id="surnameTag" class="pill">CISTERNAS</span> · Comunas de Chile</h1>
    <div id="controls">
      <label>Apellido:
        <input id="surnameInput" type="text" value="CISTERNAS" />
      </label>
      <label>URL CSV:
        <input id="csvUrl" type="text"
          value="https://docs.google.com/spreadsheets/d/1CKDZkGGO3Rbkd88GFkHYc3f_oFaQkM2RN_ESZU8e898/gviz/tq?tqx=out:csv&gid=24675813" />
      </label>
      <button id="btnLoad">Cargar</button>
    </div>
  </header>

  <div id="status">Preparando…</div>
  <div id="map"></div>

  <footer>
    Fondo negro + límites de Chile. Capa comunal (rojos) por <b>prct_apellido</b> (en porcentaje). Datos desde Google Sheets.
  </footer>
</div>

<!-- Cargar librerías de forma robusta -->
<script>
function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s=document.createElement('script'); s.src=src; s.async=true; s.defer=true;
    s.onload=resolve; s.onerror=()=>reject(new Error('No se pudo cargar: '+src));
    document.head.appendChild(s);
  });
}
function waitForGlobals(timeoutMs=15000){
  return new Promise((resolve, reject)=>{
    const t0=Date.now();(function tick(){
      if (window.L && L.map && window.Papa && Papa.parse) return resolve();
      if (Date.now()-t0>timeoutMs) return reject(new Error('Timeout esperando Leaflet/Papa'));
      setTimeout(tick,50);
    })();
  });
}
(async()=>{
  const st=document.getElementById('status');
  try{
    await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
    await loadScript('https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js');
    await waitForGlobals(); init();
  }catch(e){ st.textContent='Error cargando/iniciando: '+(e.message||e); console.error(e); }
})();
</script>

<script>
function init(){
  const $ = s => document.querySelector(s);
  function setStatus(msg, ok=true){ const el=$('#status'); el.textContent=msg; el.className=ok?'ok':'err'; }
  function normalizeTxt(s){
    try{ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim().toUpperCase(); }
    catch(e){ return (s||'').toString().toUpperCase().replace(/\s+/g,' ').trim(); }
  }
  function parsePctFlexible(v){
    if (v==null) return 0;
    if (typeof v==='number' && isFinite(v)) return v;
    let s=String(v).trim(); if(!s) return 0;
    const hadPct=s.includes('%'); s=s.replace(/\s+/g,'').replace(/%/g,'');
    if (s.includes(',') && !s.includes('.')) s=s.replace(/\./g,'').replace(/,/g,'.');
    if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) s=s.replace(/\./g,'').replace(/,/g,'.');
    const n=parseFloat(s); if(!isFinite(n)) return 0;
    return (!hadPct && n<=1) ? n*100 : n;
  }
  function loadCSV(url){
    return new Promise((resolve,reject)=>{
      Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject});
    });
  }
  async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  function getProp(props, names){
    const idx={}; for(const k of Object.keys(props||{})){ idx[k.toLowerCase().replace(/[\s_\-]/g,'')]=k; }
    for(const n of names){ const key=idx[n.toLowerCase().replace(/[\s_\-]/g,'')]; if(key) return props[key]; }
    return null;
  }
  function colorCommune(p){ const v=+p||0;
    if(v>2.5) return '#7f1d1d'; if(v>1.5) return '#991b1b'; if(v>1.0) return '#b91c1c';
    if(v>0.6) return '#dc2626'; if(v>0.3) return '#ef4444'; if(v>0.15) return '#f87171'; return '#fecaca';
  }

  // === Mapa base
  const map=L.map('map',{
    zoomControl:true, attributionControl:false, preferCanvas:true,
    zoomSnap:0.25, wheelDebounceTime:30, wheelPxPerZoomLevel:80, inertia:true, inertiaDeceleration:2500
  });
  map.setMinZoom(3.5);
  L.tileLayer('', { attribution:'' }).addTo(map);
  // Limitar vista aproximada a Chile (cojín amplio)
  map.setMaxBounds([[-56.5,-78],[-16,-62]]);
  map.setMaxBounds(map.options.maxBounds.pad(0.15));

  // Controles
  const info=L.control({position:'topright'});
  info.onAdd=function(){ this._div=L.DomUtil.create('div','info'); this.update(); return this._div; }
  info.update=function(p){
    if(!p){ this._div.innerHTML='<b>Pasa el mouse</b> por una comuna'; return; }
    const nombre=p.__name || '(sin nombre)';
    const pct=(p.__freq!=null && isFinite(p.__freq)) ? (+p.__freq).toFixed(1)+'%' : '0.0%';
    this._div.innerHTML=`<b>${nombre}</b><br>Frecuencia: <b>${pct}</b>`;
  }
  info.addTo(map);

  const legend=L.control({position:'bottomright'});
  legend.onAdd=function(){
    const div=L.DomUtil.create('div','legend');
    const stops=[0,0.15,0.3,0.6,1.0,1.5,2.5];
    div.innerHTML=`<b>Frecuencia (%)</b>`;
    stops.forEach((s,i)=>{
      const row=document.createElement('div'); row.className='scale';
      const box=document.createElement('div'); box.className='swatch';
      box.style.background=colorCommune(s+0.0001);
      const label=document.createElement('span'); label.className='label';
      const next=stops[i+1]; label.textContent=next?`${s}–${next}%`:`>${s}%`;
      row.appendChild(box); row.appendChild(label); div.appendChild(row);
    });
    return div;
  }
  legend.addTo(map);

  <script>
// Reemplaza tu loadGeoCommunesLocal() por esta versión
async function loadGeoCommunesLocal(){
  const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, '');
  const candidates = [
    new URL('comunas.json',  location.origin + base).href,
    new URL('comunas.geojson', location.origin + base).href,
    // fallback RAW (por si acaso, no debería ser necesario si el de arriba existe)
    'https://raw.githubusercontent.com/crcofre/mapa-apellidos/main/comunas.json',
    'https://raw.githubusercontent.com/crcofre/mapa-apellidos/main/comunas.geojson'
  ];

  let lastErr = '';
  for (const url of candidates){
    try{
      // Muestra en la barra de estado qué URL está intentando
      const st = document.getElementById('status');
      if (st) st.textContent = 'Cargando GeoJSON: ' + url;

      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status + ' en ' + url);
      const gj = await r.json();
      if (!gj?.features?.length) throw new Error('GeoJSON sin features en ' + url);
      return gj;
    }catch(e){
      console.warn('Fallo cargando GeoJSON:', e);
      lastErr = e.message || String(e);
    }
  }
  throw new Error('No se pudo cargar GeoJSON: ' + lastErr);
}
</script>


  async function build(){
    try{
      setStatus('Cargando CSV y GeoJSON local…');
      const csvUrl=$('#csvUrl').value.trim();
      const surname=normalizeTxt($('#surnameInput').value);
      $('#surnameTag').textContent=$('#surnameInput').value.toUpperCase();

      const [rows, gjComAll] = await Promise.all([ loadCSV(csvUrl), loadGeoCommunesLocal() ]);
      const rowsSurname = rows.filter(r=>normalizeTxt(r.apellido||r.Apellido||r.APELLIDO)===surname);

      // Índice por CUT; si no viene CUT, tratamos por nombre
      const byCUT={}, byName={};
      for(const r of rowsSurname){
        let cut=String(r.cut||r.CUT||r.cut_com||r.CUT_COM||'').trim();
        const nameCSV=r.comuna||r.Comuna||r.COMUNA||'';
        const pct=parsePctFlexible(r.prct_apellido); // ya viene en %
        if(cut){ byCUT[cut.padStart(5,'0')]={f:pct}; }
        else if(nameCSV){ byName[normalizeTxt(nameCSV)]={f:pct}; }
      }

      // Mapa auxiliar nombre→CUT desde el propio GeoJSON
      const nameToCut={};
      (gjComAll.features||[]).forEach(ft=>{
        const p=ft.properties||{};
        const cut=String(getProp(p,['CUT_COM','cut_com','Codigo comuna','codigo_comuna','cod_comuna'])||'').padStart(5,'0');
        const nombre=getProp(p,['Comuna','COMUNA','NOM_COM','name','Nombre'])||'';
        if(cut && nombre) nameToCut[normalizeTxt(nombre)]=cut;
      });
      for(const nKey of Object.keys(byName)){
        const cut=nameToCut[nKey];
        if(cut && !byCUT[cut]) byCUT[cut]=byName[nKey];
      }

      // Construir capa comunal
      if(window._communesLayer){ try{ map.removeLayer(window._communesLayer);}catch(_){ } }
      const communesFC={type:'FeatureCollection',features:[]};
      (gjComAll.features||[]).forEach(f=>{
        const p=f.properties||{};
        const cut=String(getProp(p,['CUT_COM','cut_com','Codigo comuna','codigo_comuna','cod_comuna'])||'').padStart(5,'0');
        const nombre=getProp(p,['Comuna','COMUNA','NOM_COM','name','Nombre'])||'(sin nombre)';
        const hit=byCUT[cut];
        const props=Object.assign({},p,{__name:nombre,__freq:hit?hit.f:0});
        communesFC.features.push({type:'Feature',properties:props,geometry:f.geometry});
      });

      window._communesLayer=L.geoJSON(communesFC,{
        style:ft=>({color:'#7f1d1d',weight:.8,fillOpacity:.85,fillColor:colorCommune(ft.properties.__freq)}),
        onEachFeature:(feature,lyr)=>{
          const p=feature.properties;
          lyr.on({
            mouseover:(e)=>{ e.target.setStyle({weight:2}); info.update(p); },
            mouseout:(e)=>{ window._communesLayer.resetStyle(e.target); info.update(); },
            click:(e)=> map.fitBounds(e.target.getBounds())
          });
          const pctTxt=(p.__freq!=null && isFinite(p.__freq))?p.__freq.toFixed(1)+'%':'0.0%';
          lyr.bindTooltip(`<b>${p.__name}</b><br>Frecuencia: <b>${pctTxt}</b>`,{sticky:true});
        }
      }).addTo(map);

      map.fitBounds(window._communesLayer.getBounds(),{padding:[40,40]});
      setStatus(`OK: comunas pintadas: ${communesFC.features.length}`,true);
    }catch(err){
      console.error(err);
      setStatus('Error: '+(err.message||err),false);
    }
  }

  document.getElementById('btnLoad').addEventListener('click', build);
  build();
}
</script>
</body>
</html>
