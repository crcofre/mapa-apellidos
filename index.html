<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile (debug)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; background:#f7f7f7; }
    .ui{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#ffffffeb; backdrop-filter: blur(3px);
      border:1px solid #ddd; border-radius:10px; padding:10px 12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      max-width:min(92vw, 460px);
    }
    .ui h3{ margin:0 0 6px 0; font-size:14px; font-weight:700; }
    .ui .row{ display:flex; gap:6px; }
    .ui input{ flex:1; padding:6px 8px; font-size:14px; border:1px solid #ccc; border-radius:8px; }
    .ui button{ padding:6px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:600; background:#0b5ed7; color:#fff; }
    .ui small{ display:block; margin-top:6px; color:#555; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .legend{
      line-height:16px; color:#333; background:#fff; padding:8px 10px;
      border-radius:8px; border:1px solid #ddd; box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; font-size:12px;
    }
    .legend .item{ display:flex; align-items:center; gap:6px; }
    .legend .swatch{ width:18px; height:12px; border:1px solid #999; }

    .debug{
      margin-top:8px; font-size:12px; background:#fff; border:1px dashed #aaa; border-radius:8px; padding:8px;
      max-height:160px; overflow:auto; color:#333;
    }
    .debug b{ color:#000; }
    .debug .line{ margin:2px 0; }
    .warn{ color:#b36b00; }
    .err{ color:#b00000; font-weight:600; }
  </style>
</head>
<body>
  <div class="ui">
    <h3>Consulta tu apellido</h3>
    <div class="row">
      <input id="apellidoInput" type="text" placeholder="Ej.: Cisternas" list="apellidosList" autocomplete="off"/>
      <button id="btn-buscar">Buscar</button>
    </div>
    <datalist id="apellidosList"></datalist>
    <small id="estado">Cargando…</small>
    <div class="debug" id="debug"></div>
  </div>

  <div id="map"></div>

  <script>
    // ============= UTILIDAD DE LOG =============
    const dbgEl = document.getElementById('debug');
    function dlog(msg, kind="log", obj){
      const ts = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = 'line ' + (kind==="warn" ? "warn": kind==="error" ? "err" : "");
      div.textContent = `[${ts}] ${msg}`;
      dbgEl.appendChild(div);
      dbgEl.scrollTop = dbgEl.scrollHeight;
      if (kind==="warn") console.warn(msg, obj ?? "");
      else if (kind==="error") console.error(msg, obj ?? "");
      else console.log(msg, obj ?? "");
    }
    function setEstado(t){ document.getElementById('estado').textContent = t; dlog(`ESTADO: ${t}`); }

    // ============= CONFIG (AUTO-DETECT BASE) =============
    const SITE_BASE = (()=>{
      // Usa el path actual (ej: https://crcofre.github.io/mapa-apellidos)
      const base = (location.origin + location.pathname).replace(/\/$/, "");
      dlog(`SITE_BASE = ${base}`);
      return base;
    })();

    // Tu estructura actual (shards en /data/*.json):
    const MANIFEST_URL = `${SITE_BASE}/data/apellidos_manifest.json`;
    const SHARDS_BASE  = `${SITE_BASE}/data/`; // << shards aquí
    const INDEX_URL    = `${SITE_BASE}/data/index_apellidos.json`;

    // GeoJSON (en la raíz del repo)
    const GEO_REG = `${SITE_BASE}/regiones.json`;
    const GEO_PRO = `${SITE_BASE}/provincias.json`;
    const GEO_COM = `${SITE_BASE}/comunas.json`;

    dlog("RUTAS", {MANIFEST_URL, SHARDS_BASE, INDEX_URL, GEO_REG, GEO_PRO, GEO_COM});

    // ============= MAPA =============
    const map = L.map('map', { center: [-35.6751, -71.5430], zoom: 5, minZoom: 4, maxZoom: 12 });
    // Fondo para que siempre veas algo
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const regionesLayer = L.layerGroup().addTo(map);
    const provinciasLayer = L.layerGroup().addTo(map);
    const comunasLayer = L.layerGroup().addTo(map);
    let regionesGeo=null, provinciasGeo=null, comunasGeo=null;

    // Paletas y bins
    const PALETAS = {
      region:    ["#d7ebff","#badaff","#9cc9ff","#7fb8ff","#62a7ff","#458fff","#2a73e0"],
      provincia: ["#e2f7ee","#c6efdc","#a9e6c9","#8cddb7","#6fc5a0","#4fae85","#2f956b"],
      comuna:    ["#fde6e9","#fdc9cf","#fdaaae","#fb8b8d","#f25f63","#d84349","#a92d31"]
    };
    const BINS_BY_LEVEL = {
      region:   [0, 0.05, 0.10, 0.20, 0.40, 0.80, 1.50, Infinity],
      provincia:[0, 0.10, 0.20, 0.40, 0.80, 1.20, 2.00, Infinity],
      comuna:   [0, 0.15, 0.30, 0.60, 1.00, 1.50, 2.50, Infinity]
    };

    // Leyenda
    let nivelActual = "region";
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){ this._div = L.DomUtil.create('div','legend'); this.update(); return this._div; };
    legend.update = function(){
      const bins = BINS_BY_LEVEL[nivelActual];
      this._div.innerHTML = "<b>Frecuencia (%)</b><br>" + bins.slice(0,-1).map((b,i)=>{
        const next = bins[i+1]; const label = (next===Infinity) ? `>${b}%` : `${b}%–${next}%`;
        return `<div class="item"><span class="swatch" style="background:${PALETAS[nivelActual][i]}"></span>${label}</div>`;
      }).join("");
    };
    legend.addTo(map);

    // ====== helpers ======
    const getProp = (p, keys, def="—") => { for(const k of keys){ if(p && p[k]!=null && p[k]!=="") return p[k]; } return def; };
    const norm = s => {
      if (!s) return "";
      let t = String(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();
      t = t.replace(/^\s*\d+\s*[\.\-]?\s*/, ""); // quita prefijo numérico tipo "05. REGION..."
      t = t.replace(/^(REGION|PROVINCIA|DEPARTAMENTO)\s+(DEL\s+|DE\s+)?/, "").replace(/^(DEL|DE)\s+/, "");
      return t.trim();
    };
    function colorByBins(v, pal, bins){
      if (v==null || isNaN(v)) return pal[0];
      for (let i=0; i<bins.length-1; i++){
        if (v >= bins[i] && v < bins[i+1]) return pal[i];
      }
      return pal[pal.length-1];
    }

    // ====== Cargar GeoJSON ======
    async function safeFetchJSON(url, name){
      dlog(`fetch → ${name}: ${url}`);
      const res = await fetch(url);
      dlog(`respuesta ${name}: ${res.status} ${res.statusText}`);
      if (!res.ok) throw new Error(`No pude cargar ${name} (${res.status})`);
      const json = await res.json();
      dlog(`OK ${name}: keys=${Object.keys(json)}`);
      return json;
    }

    (async function loadGeo(){
      try{
        const [geoReg, geoProv, geoCom] = await Promise.all([
          safeFetchJSON(GEO_REG, "regiones.json"),
          safeFetchJSON(GEO_PRO, "provincias.json"),
          safeFetchJSON(GEO_COM, "comunas.json")
        ]);

        const styleBase = { color:"#666", weight:1, fillColor:"#ddd", fillOpacity:.6 };

        regionesGeo = L.geoJSON(geoReg, {
          style: f => ({...styleBase, color:"#587fbf", weight:1 }),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{}, reg=getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región");
            layer.bindTooltip(reg,{sticky:true,opacity:.95});
          }
        }).addTo(regionesLayer);

        provinciasGeo = L.geoJSON(geoProv, {
          style: f => ({...styleBase, color:"#333", weight:1 }),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{}, prov=getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia");
            layer.bindTooltip(prov,{sticky:true,opacity:.95});
          }
        }).addTo(provinciasLayer);

        comunasGeo = L.geoJSON(geoCom, {
          style: f => ({...styleBase, color:"#990000", weight:.8 }),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{}, com=getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
            layer.bindTooltip(com,{sticky:true,opacity:.95});
          }
        }).addTo(comunasLayer);

        updateVisibility();
        map.on('zoomend', updateVisibility);
        dlog("GeoJSON cargados y agregados al mapa.");
      }catch(err){
        dlog("Error cargando GeoJSON", "error", err);
        setEstado("No pude cargar GeoJSON. Revisa rutas/ubicación de regiones.json, provincias.json y comunas.json.");
      }
    })();

    function updateVisibility(){
      const z = map.getZoom();
      regionesLayer.clearLayers(); provinciasLayer.clearLayers(); comunasLayer.clearLayers();
      if (z <= 6) { regionesLayer.addLayer(regionesGeo);  nivelActual="region"; }
      else if (z <= 7) { provinciasLayer.addLayer(provinciasGeo); nivelActual="provincia"; }
      else { comunasLayer.addLayer(comunasGeo); nivelActual="comuna"; }
      legend.update();
      if (window.__ultimo) pintar(window.__ultimo);
      dlog(`updateVisibility → zoom=${z}, nivel=${nivelActual}`);
    }

    // ====== Carga de datos (manifest + índice) ======
    let MANIFEST=null, INDICE=[];

    <script>
let MANIFEST = null, INDICE = [];

async function boot(){
  try{
    // Cargamos sólo el índice (para autocompletar)
    const idxRes = await fetch(INDEX_URL);
    if (!idxRes.ok) throw new Error("No pude cargar index_apellidos.json");
    INDICE = await idxRes.json();

    // Si el manifest no está, lo generamos en el cliente:
    // Regla: shard = "apellidos_" + primeras 2 letras del slug + ".json"
    // (rellenamos con "_" si hiciera falta)
    MANIFEST = {};
    for (const it of INDICE){
      const slug = (it.slug || "").toLowerCase();
      const pref = (slug.slice(0,2) || "__");
      MANIFEST[slug] = `apellidos_${pref}.json`;
    }

    // autocompletar
    const dl = document.getElementById('apellidosList');
    dl.innerHTML = INDICE.map(x=>`<option value="${x.apellido}"></option>`).join('');

    setEstado("Listo. Escribe tu apellido y presiona Buscar.");
    dlog("Manifest generado en cliente", "log", {ejemplos: Object.entries(MANIFEST).slice(0,5)});
  }catch(err){
    dlog("Error en boot()", "error", err);
    setEstado("No pude cargar el índice / generar manifest.");
  }
}
</script>


    // ====== Cargar un apellido desde su shard ======
    function slugify(s){
      return String(s ?? "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ").trim().toLowerCase()
        .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    }

    async function cargarApellido(apellidoTexto){
      dlog(`cargarApellido("${apellidoTexto}")`);
      const slug = (INDICE.find(x => x.apellido.toUpperCase()===String(apellidoTexto).toUpperCase())?.slug) || slugify(apellidoTexto);
      dlog(`slug resuelto: ${slug}`);
      const shardName = MANIFEST?.[slug] || MANIFEST?.[slug.toLowerCase()];
      if (!shardName) throw new Error(`Apellido no disponible (manifest no tiene slug: ${slug}).`);

      const url = SHARDS_BASE + shardName;
      dlog(`fetch shard: ${url}`);
      const res = await fetch(url);
      dlog(`respuesta shard: ${res.status} ${res.statusText}`);
      if (!res.ok) throw new Error(`No pude leer shard ${shardName} (${res.status}).`);

      const shardData = await res.json();
      const data = shardData[slug] || shardData[slug.toLowerCase()] || shardData[slug.toUpperCase()];
      if (!data) throw new Error(`No encontré el apellido "${slug}" dentro de ${shardName}.`);
      dlog(`OK apellido "${data.apellido}" con ${data.comunas?.length||0} filas.`);
      return data;
    }

    // ====== Pintado ======
    function construirTablasValor(data){
      const reg = {}, prov = {}, com = {};
      for (const r of data.comunas || []){
        com[norm(r.comuna)] = r.prct_apellido ?? 0;
        const kProv = norm(r.provincia);
        const kReg  = norm(r.region);
        if (r.freq_prov!=null && !(kProv in prov)) prov[kProv] = r.freq_prov;
        if (r.freq_reg !=null && !(kReg  in reg )) reg[kReg ] = r.freq_reg;
      }
      return {reg, prov, com};
    }
    function valorFeature(f, nivel, tablas){
      const p = f.properties || {};
      if (nivel==="region"){
        const key = norm(getProp(p,["REGION","NOM_REG","Región","NAME_1"],""));
        return tablas.reg[key];
      }else if (nivel==="provincia"){
        const key = norm(getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],""));
        return tablas.prov[key];
      }else{
        const key = norm(getProp(p,["COMUNA","NOM_COM","Comuna","name"],""));
        return tablas.com[key];
      }
    }
    function pintar(data){
      window.__ultimo = data;
      const tablas = construirTablasValor(data);
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const pctFmt = v => (v==null || isNaN(v)) ? "0%" : `${(+v).toFixed(2).replace('.',',')}%`;

      const pintarCapa = (geo, nivel) => {
        if (!geo) { dlog(`No hay geo para ${nivel}`, "warn"); return; }
        geo.eachLayer(l=>{
          const v = valorFeature(l.feature, nivel, tablas);
          l.setStyle({ fillColor: colorByBins(v, pal, bins), fillOpacity:.65 });
          const p=l.feature.properties||{};
          const nombre = (nivel==="region")
            ? getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región")
            : (nivel==="provincia")
              ? getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia")
              : getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          l.bindTooltip(`${nombre}<br><small>${data.apellido}: <b>${pctFmt(v)}</b></small>`, {sticky:true,opacity:.95});
        });
      };

      const z = map.getZoom();
      if (z <= 6) pintarCapa(regionesGeo,"region");
      else if (z <= 7) pintarCapa(provinciasGeo,"provincia");
      else pintarCapa(comunasGeo,"comuna");

      setEstado(`Mostrando "${data.apellido}" (${nivelActual}).`);
    }

    // ====== UI ======
    async function onBuscar(){
      const v = document.getElementById('apellidoInput').value.trim();
      if (!v) return;
      setEstado(`Cargando "${v}"…`);
      try{
        const data = await cargarApellido(v);
        pintar(data);
      }catch(e){
        setEstado(e.message);
        dlog(e.message, "error", e);
      }
    }
    document.getElementById('btn-buscar').addEventListener('click', onBuscar);
    document.getElementById('apellidoInput').addEventListener('keydown', e=>{ if(e.key==="Enter") onBuscar(); });

    // ====== Inicio ======
    (async function start(){
      setEstado("Cargando manifest, índice y GeoJSON…");
      await boot(); // manifest + index
      // geojson se carga en paralelo al inicio; si ya terminó, updateVisibility() habrá corrido
      dlog("Boot completado.");
    })();
  </script>
</body>
</html>
