<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- d3 para leer CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; background:#f7f7f7; }
    .leaflet-tooltip{
      font-family:"Book Antiqua",serif; font-size:13px; font-weight:bold;
      color:#000; background:rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.2); border-radius:4px; padding:3px 6px;
    }
    path.leaflet-interactive:focus { outline:none; filter:drop-shadow(0 0 2px rgba(0,0,0,.4)); }

    /* UI */
    .search-ui{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#ffffffeb; backdrop-filter: blur(3px);
      border:1px solid #ddd; border-radius:10px; padding:10px 12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      max-width: min(92vw, 460px);
    }
    .search-ui h3{ margin:0 0 6px 0; font-size:14px; font-weight:700; }
    .search-ui .row{ display:flex; gap:6px; margin-bottom:6px; }
    .search-ui input, .search-ui select{
      flex:1; padding:6px 8px; font-size:14px; border:1px solid #ccc; border-radius:8px;
    }
    .search-ui button{
      padding:6px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:600;
      background:#0b5ed7; color:#fff;
    }
    .search-ui small{ display:block; margin-top:2px; color:#555; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .legend{
      line-height:16px; color:#333; background:#fff; padding:8px 10px;
      border-radius:8px; border:1px solid #ddd; box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; font-size:12px;
    }
    .legend .item{ display:flex; align-items:center; gap:6px; }
    .legend .swatch{ width:18px; height:12px; border:1px solid #999; }
    .legend b{ display:block; margin-bottom:4px; }

    /* Panel de logs */
    .log-panel{
      position:fixed; right:12px; top:12px; z-index:1100;
      width:min(38vw, 420px); max-height:46vh; overflow:auto;
      font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#111; color:#eaeaea; border:1px solid #333; border-radius:10px;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .log-panel header{ position:sticky; top:0; background:#0d0d0d; color:#9ad; padding:6px 8px; font-weight:700; }
    .log-panel pre{ margin:0; padding:8px; white-space:pre-wrap; word-break:break-word; }
    .log-ok{ color:#9f9; }
    .log-warn{ color:#ff9; }
    .log-err{ color:#f99; }
    .log-dim{ color:#aaa; }
  </style>
</head>
<body>
  <!-- UI de búsqueda -->
  <div class="search-ui">
    <h3>Consulta tu apellido</h3>
    <div class="row">
      <input id="apellidoInput" type="text" placeholder="Ej.: Cisternas" list="apellidosList" autocomplete="off" />
      <button id="buscarBtn">Buscar</button>
    </div>
    <div class="row">
      <select id="nivelSelect" title="Nivel de visualización">
        <option value="auto" selected>Auto (según zoom)</option>
        <option value="region">Región</option>
        <option value="provincia">Provincia</option>
        <option value="comuna">Comuna</option>
      </select>
    </div>
    <datalist id="apellidosList"></datalist>
    <small id="estado">Cargando datos…</small>
  </div>

  <!-- Panel de logs -->
  <div class="log-panel" id="logPanel">
    <header>Logs</header>
    <pre id="logText"></pre>
  </div>

  <div id="map"></div>

  <script>
    /* ---------- Logger ---------- */
    const $log = document.getElementById('logText');
    const log = (msg, level='dim') => {
      const ts = new Date().toISOString().substring(11,19);
      const line = `[${ts}] ${msg}\n`;
      $log.insertAdjacentText('beforeend', line);
      $log.className = `log-${level}`;
      if(level==='err') console.error(msg); else if(level==='warn') console.warn(msg); else console.log(msg);
      $log.scrollTop = $log.scrollHeight;
    };

    // ----------------- Config -----------------
    const map = L.map('map', { center: [-35.6751, -71.5430], zoom: 5, minZoom: 4, maxZoom: 12 });

    const BASES = [
      "https://crcofre.github.io/mapa-apellidos",
      "https://raw.githubusercontent.com/crcofre/mapa-apellidos/main"
    ];
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/1CKDZkGGO3Rbkd88GFkHYc3f_oFaQkM2RN_ESZU8e898/export?format=csv&gid=24675813";

    const ALIASES = {
      reg_pct: ["Frecuencia Regiones","Frecuencia regiones","Frecuencia Región","Frecuencia región","frecuencia_regiones","frecuencia_region"],
      prov_pct:["Frecuencia provincia","Frecuencia Provincia","frecuencia_provincia"],
      com_pct: ["prct_apellido","pcrt_apellidos","Frecuencia Comuna","frecuencia_comuna"],
      reg_name:["region","Region","REGION","Nombre Región","Nombre region"],
      prov_name:["provincia","Provincia","PROVINCIA","Nombre Provincia"],
      com_name:["comuna","Comuna","COMUNA","Nombre Comuna"],
      apellido:["apellido","Apellido","APELLIDO"]
    };
    function getAny(row, keys){ for(const k of keys){ if(Object.prototype.hasOwnProperty.call(row,k)){ const v=row[k]; if(v!=null && String(v).trim()!=="") return v; } } return ""; }
    const norm = s => {
      if (!s) return "";
      let t = String(s).normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").trim().toUpperCase();
      t = t.replace(/^\s*\d+\s*[\.\-]?\s*/,"").replace(/^(REGION|PROVINCIA|DEPARTAMENTO)\s+(DEL\s+|DE\s+)?/,"").replace(/^(DEL|DE)\s+/,"");
      return t.trim();
    };
    const parsePct = x => { if(x==null) return 0; let s=String(x).trim().replace(',','.'); if(s.endsWith('%')) s=s.slice(0,-1); const v=parseFloat(s); return isNaN(v)?0:v; };

    map.createPane('pane-regiones'); map.createPane('pane-provincias'); map.createPane('pane-comunas');
    const regionesLayer=L.layerGroup(), provinciasLayer=L.layerGroup(), comunasLayer=L.layerGroup();
    let regionesGeo=null, provinciasGeo=null, comunasGeo=null;

    let dataRows = [];
    let indice = { region:{}, provincia:{}, comuna:{} };
    let apellidoActual = "Cisternas";

    // NUEVO: modo de nivel (auto/manual)
    let nivelMode = 'auto';           // 'auto' | 'manual'
    let nivelActual = 'region';       // región/provincia/comuna (se decide por zoom si auto)
    const $nivelSelect = document.getElementById('nivelSelect');

    // Autocomplete
    let apellidosDisponibles = [];
    const apellidosCanonPorNorm = new Map();

    // Paletas y bins
    const PALETAS = {
      region:    ["#d7ebff","#badaff","#9cc9ff","#7fb8ff","#62a7ff","#458fff","#2a73e0"],
      provincia: ["#e2f7ee","#c6efdc","#a9e6c9","#8cddb7","#6fc5a0","#4fae85","#2f956b"],
      comuna:    ["#fde6e9","#fdc9cf","#fdaaae","#fb8b8d","#f25f63","#d84349","#a92d31"]
    };
    const BINS_BY_LEVEL = {
      region:   [0, 0.05, 0.10, 0.20, 0.40, 0.80, 1.50, Infinity],
      provincia:[0, 0.10, 0.20, 0.40, 0.80, 1.20, 2.00, Infinity],
      comuna:   [0, 0.15, 0.30, 0.60, 1.00, 1.50, 2.50, Infinity]
    };

    const getProp = (p, keys, def="—") => { for(const k of keys){ if(p && p[k]!=null && p[k]!=="") return p[k]; } return def; };
    function colorByBins(v, pal, bins){ if(v==null||isNaN(v)) return pal[0]; for(let i=0;i<bins.length-1;i++){ if(v>=bins[i] && v<bins[i+1]) return pal[i]; } return pal[pal.length-1]; }
    function labelsFromBins(bins){ const fmt=x=>(x===Infinity)?"∞":`${(+x).toLocaleString('es-CL',{maximumFractionDigits:2})}%`; const labs=[]; for(let i=0;i<bins.length-1;i++){ const a=bins[i], b=bins[i+1]; labs.push(b===Infinity?`>${fmt(a)}`:`${fmt(a)}–${fmt(b)}`);} return labs; }

    /* ---------- Fetch robusto ---------- */
    async function delay(ms){ return new Promise(r=>setTimeout(r, ms)); }
    async function safeFetchOnce(url, opts={}){
      const res = await fetch(url, { cache:'no-cache', ...opts });
      if(!res.ok){ const text = await res.text().catch(()=>"(sin cuerpo)"); throw Object.assign(new Error(`HTTP ${res.status} en ${url}\n${text.slice(0,200)}`),{status:res.status, body:text}); }
      const ct = res.headers.get('content-type') || '';
      const bodyText = await res.text();
      if(!/application\/json|geo\+json|json/i.test(ct)){
        try { return JSON.parse(bodyText); } catch(e){ throw new Error(`Contenido no-JSON desde ${url} (ct="${ct}"). Inicio: ${bodyText.slice(0,200)}`); }
      }
      try { return JSON.parse(bodyText); } catch(e){ throw new Error(`JSON inválido en ${url}: ${e.message}. Inicio: ${bodyText.slice(0,200)}`); }
    }
    async function safeFetchJSON(paths, {retries=4, baseList=BASES}={}){
      const jitter = () => Math.floor(200 + Math.random()*300);
      let lastErr=null;
      for(const base of baseList){
        for(let attempt=0; attempt<=retries; attempt++){
          const url = `${base}/${paths}?_=${Date.now()}`;
          try{
            log(`GET ${url}`,'dim');
            const json = await safeFetchOnce(url);
            log(`OK ${url}`,'ok');
            return json;
          }catch(err){
            lastErr = err; const status = err.status || 0;
            const backoff = Math.min(1500*Math.pow(1.7,attempt),6000) + jitter();
            const retriable = [0,429,500,502,503,504].includes(status);
            log(`Error en ${url}: ${err.message.split('\n')[0]}`, retriable?'warn':'err');
            if(attempt<retries && retriable){ log(`Reintento ${attempt+1}/${retries} en ${(backoff/1000).toFixed(1)}s`,'dim'); await delay(backoff); continue; }
            break;
          }
        }
        log(`Fallback al siguiente host…`,'warn');
      }
      throw lastErr || new Error('Fallo de red desconocido');
    }

    /* ---------- Cargar GeoJSON ---------- */
    (async function loadGeo(){
      try{
        const [geoReg, geoProv, geoCom] = await Promise.all([
          safeFetchJSON("regiones.json"),
          safeFetchJSON("provincias.json"),
          safeFetchJSON("comunas.json")
        ]);

        const styleBase = { color:"#666", weight:1, fillColor:"#ddd", fillOpacity:.6 };

        regionesGeo = L.geoJSON(geoReg, {
          pane:'pane-regiones',
          style: f => ({...styleBase, color:"#587fbf", weight:1 }),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{}, reg=getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región");
            layer.bindTooltip(reg,{sticky:true,opacity:.95});
            layer.on('mouseover', ()=> layer.setStyle({weight:2}));
            layer.on('mouseout',  ()=> layer.setStyle({weight:1}));
          }
        });

        provinciasGeo = L.geoJSON(geoProv, {
          pane:'pane-provincias',
          style: f => ({...styleBase, color:"#333", weight:1 }),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{}, prov=getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia");
            layer.bindTooltip(prov,{sticky:true,opacity:.95});
            layer.on('mouseover', ()=> layer.setStyle({weight:2}));
            layer.on('mouseout',  ()=> layer.setStyle({weight:1}));
          }
        });

        comunasGeo = L.geoJSON(geoCom, {
          pane:'pane-comunas',
          style: f => ({...styleBase, color:"#990000", weight:.8 }),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{}, com=getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
            layer.bindTooltip(com,{sticky:true,opacity:.95});
            layer.on('mouseover', ()=> layer.setStyle({weight:1.2}));
            layer.on('mouseout',  ()=> layer.setStyle({weight:.8}));
          }
        });

        updateVisibility();
        map.on('zoomend', ()=>{ if(nivelMode==='auto') updateVisibility(); });
        log('GeoJSON cargados y capas listas','ok');
      }catch(err){
        log('Error cargando GeoJSON: ' + err.message, 'err');
        document.getElementById('estado').textContent = 'Error cargando mapas. Revisa logs.';
      }
    })();

    /* ---------- Leer Google Sheet ---------- */
    (async function loadCSV(){
      try{
        log('Cargando CSV de Google Sheets…','dim');
        const res = await fetch(SHEET_CSV, {cache:'no-cache'});
        if(!res.ok) throw new Error(`HTTP ${res.status} al leer Sheet`);
        const csvText = await res.text();
        dataRows = d3.csvParse(csvText);
        construirIndice();
        poblarDatalistApellidos();
        document.getElementById('estado').textContent = `Listo. Apellido por defecto: ${apellidoActual}`;
        actualizarPintado();
        log(`CSV cargado. Filas: ${dataRows.length}`,'ok');
      }catch(err){
        log('Error cargando CSV: ' + err.message, 'err');
        document.getElementById('estado').textContent = "No se pudo cargar el CSV. Revisa permisos del Sheet.";
      }
    })();

    function construirIndice(){
      indice = { region:{}, provincia:{}, comuna:{} };
      for(const r of dataRows){
        const apRaw = getAny(r, ALIASES.apellido);
        const ap    = norm(apRaw);
        if(!ap) continue;

        const regNom = norm(getAny(r, ALIASES.reg_name));
        const provNom= norm(getAny(r, ALIASES.prov_name));
        const comNom = norm(getAny(r, ALIASES.com_name));

        const fReg  = parsePct(getAny(r, ALIASES.reg_pct));
        const fProv = parsePct(getAny(r, ALIASES.prov_pct));
        const fCom  = parsePct(getAny(r, ALIASES.com_pct));

        if(!indice.region[ap])    indice.region[ap]    = {};
        if(!indice.provincia[ap]) indice.provincia[ap] = {};
        if(!indice.comuna[ap])    indice.comuna[ap]    = {};

        if(regNom)  indice.region[ap][regNom]     = fReg;
        if(provNom) indice.provincia[ap][provNom] = fProv;
        if(comNom)  indice.comuna[ap][comNom]     = fCom;

        const canon = String(apRaw).trim();
        if(canon){ const key = ap; if(!apellidosCanonPorNorm.has(key)) apellidosCanonPorNorm.set(key, canon); }
      }
      apellidosDisponibles = Array.from(new Set([...apellidosCanonPorNorm.values()]))
        .sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    }

    function poblarDatalistApellidos(){
      const dl = document.getElementById('apellidosList');
      dl.innerHTML = apellidosDisponibles.map(a=>`<option value="${a}"></option>`).join('');
    }

    function valorFeature(f, nivel, ap){
      const p=f.properties||{};
      if(nivel==="region"){
        const key = norm(getProp(p,["REGION","NOM_REG","Región","NAME_1"],""));
        return (indice.region[ap]||{})[key];
      }else if(nivel==="provincia"){
        const key = norm(getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],""));
        return (indice.provincia[ap]||{})[key];
      }else{
        const key = norm(getProp(p,["COMUNA","NOM_COM","Comuna","name"],""));
        return (indice.comuna[ap]||{})[key];
      }
    }

    function computeNivelByZoom(z){ return (z<=6) ? 'region' : (z<=7) ? 'provincia' : 'comuna'; }

    function actualizarPintado(){
      const ap = norm(apellidoActual);

      // Determinar nivel de trabajo
      if(nivelMode==='auto'){
        const z = map.getZoom();
        nivelActual = computeNivelByZoom(z);
      }
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const pctFmt = v => (v==null || isNaN(v)) ? "0%" : `${(+v).toFixed(2).replace('.',',')}%`;

      const pintar = (geo, nivel)=>{
        if(!geo) return;
        geo.eachLayer(l=>{
          const v = valorFeature(l.feature, nivel, ap);
          const fill = colorByBins(v, pal, bins);
          l.setStyle({ fillColor: fill, fillOpacity: .65 });
          const p=l.feature.properties||{};
          const nombre = (nivel==="region")
            ? getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región")
            : (nivel==="provincia")
              ? getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia")
              : getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          l.bindTooltip(`${nombre}<br><small>${apellidoActual}: <b>${pctFmt(v)}</b></small>`, {sticky:true,opacity:.95});
        });
      };

      if(nivelActual==="region")   pintar(regionesGeo,"region");
      if(nivelActual==="provincia")pintar(provinciasGeo,"provincia");
      if(nivelActual==="comuna")   pintar(comunasGeo,"comuna");

      actualizarLeyenda();
      document.getElementById('estado').textContent =
        `Mostrando "${apellidoActual}" por ${nivelActual}` + (nivelMode==='auto' ? ` (zoom ${map.getZoom()})` : ' (selección manual)');
    }

    function updateVisibility(){
      // Decide nivel según modo
      const targetNivel = (nivelMode==='auto') ? computeNivelByZoom(map.getZoom()) : nivelActual;

      // Quita capas actuales
      regionesLayer.clearLayers(); provinciasLayer.clearLayers(); comunasLayer.clearLayers();
      if(map.hasLayer(regionesLayer)) map.removeLayer(regionesLayer);
      if(map.hasLayer(provinciasLayer)) map.removeLayer(provinciasLayer);
      if(map.hasLayer(comunasLayer)) map.removeLayer(comunasLayer);

      // Añade sólo la capa del nivel elegido
      if (targetNivel === 'region') {
        if(regionesGeo){ regionesLayer.addLayer(regionesGeo); regionesLayer.addTo(map); }
      } else if (targetNivel === 'provincia') {
        if(provinciasGeo){ provinciasLayer.addLayer(provinciasGeo); provinciasLayer.addTo(map); }
      } else {
        if(comunasGeo){ comunasLayer.addLayer(comunasGeo); comunasLayer.addTo(map); }
      }

      // Fija nivelActual coherente y repinta
      nivelActual = targetNivel;
      actualizarPintado();
    }

    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){ this._div = L.DomUtil.create('div','legend'); this.update(); return this._div; };
    legend.update = function(){
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const labs = labelsFromBins(bins);
      let html = `<b>Frecuencia (%)</b><br>`;
      for(let i=0;i<labs.length;i++){ html += `<div class="item"><span class="swatch" style="background:${pal[i]}"></span>${labs[i]}</div>`; }
      this._div.innerHTML = html;
    };
    legend.addTo(map);
    function actualizarLeyenda(){ legend.update(); }

    function buscarApellido(){
      const input = document.getElementById('apellidoInput');
      const v = input.value.trim();
      if(!v) return;

      const key = norm(v);
      let canon = apellidosCanonPorNorm.get(key);
      if(!canon){
        const found = apellidosDisponibles.find(a => norm(a).startsWith(key));
        if(found) canon = found;
      }
      apellidoActual = canon || v;
      actualizarPintado();
    }

    document.getElementById('buscarBtn').addEventListener('click', buscarApellido);
    document.getElementById('apellidoInput').addEventListener('keydown', (e)=>{ if(e.key==="Enter") buscarApellido(); });

    // NUEVO: cambio de nivel manual/auto
    $nivelSelect.addEventListener('change', ()=>{
      const v = $nivelSelect.value;
      if(v === 'auto'){
        nivelMode = 'auto';
      }else{
        nivelMode = 'manual';
        nivelActual = v; // fuerza nivel
      }
      updateVisibility();
      log(`Nivel set: ${nivelMode==='auto' ? 'Auto' : 'Manual → ' + nivelActual}`, 'ok');
    });
  </script>
</body>
</html>
