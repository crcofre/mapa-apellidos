<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- d3 para leer CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; background:#f7f7f7; }
    .leaflet-tooltip{
      font-family:"Book Antiqua",serif; font-size:13px; font-weight:bold;
      color:#000; background:rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.2); border-radius:4px; padding:3px 6px;
    }
    path.leaflet-interactive:focus { outline:none; filter:drop-shadow(0 0 2px rgba(0,0,0,.4)); }

    /* UI búsqueda */
    .search-ui{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#ffffffeb; backdrop-filter: blur(3px);
      border:1px solid #ddd; border-radius:10px; padding:10px 12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .search-ui h3{ margin:0 0 6px 0; font-size:14px; font-weight:700; }
    .search-ui .row{ display:flex; gap:6px; }
    .search-ui input{ flex:1; padding:6px 8px; font-size:14px; border:1px solid #ccc; border-radius:8px; }
    .search-ui button{
      padding:6px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:600;
      background:#0b5ed7; color:#fff;
    }
    .search-ui small{ display:block; margin-top:6px; color:#555; }

    .legend{
      line-height:16px; color:#333; background:#fff; padding:8px 10px;
      border-radius:8px; border:1px solid #ddd; box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; font-size:12px;
    }
    .legend .item{ display:flex; align-items:center; gap:6px; }
    .legend .swatch{ width:18px; height:12px; border:1px solid #999; }
    .legend b{ display:block; margin-bottom:4px; }
  </style>
</head>
<body>
  <!-- UI de búsqueda -->
  <div class="search-ui">
    <h3>Consulta tu apellido</h3>
    <div class="row">
      <input id="apellidoInput" type="text" placeholder="Ej.: Cisternas" />
      <button id="buscarBtn">Buscar</button>
    </div>
    <small id="estado">Cargando datos…</small>
  </div>

  <div id="map"></div>

  <script>
    // ----------------- Configuración general -----------------
    const map = L.map('map', { center: [-35.6751, -71.5430], zoom: 5, minZoom: 4, maxZoom: 12 });
    const BASE = "https://raw.githubusercontent.com/crcofre/mapa-apellidos/main";

    // CSV de Google Sheets (asegura permisos "cualquiera con el enlace")
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/1CKDZkGGO3Rbkd88GFkHYc3f_oFaQkM2RN_ESZU8e898/export?format=csv&gid=24675813";

    // Panes / capas
    map.createPane('pane-regiones');
    map.createPane('pane-provincias');
    map.createPane('pane-comunas');

    const regionesLayer   = L.layerGroup();
    const provinciasLayer = L.layerGroup();
    const comunasLayer    = L.layerGroup();

    let regionesGeo=null, provinciasGeo=null, comunasGeo=null;

    // Estado
    let dataRows = [];
    let indice = { region:{}, provincia:{}, comuna:{} };
    let apellidoActual = "Cisternas";
    let nivelActual = "region";  // region | provincia | comuna

    // Normalizador
    const norm = s => (s||"").toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g," ").trim().toUpperCase();

    // Parser porcentajes ("1.8%" o "1,8%" -> 1.8 número)
    const parsePct = (x) => {
      if (x == null) return 0;
      let s = String(x).trim().replace(',', '.');
      if (s.endsWith('%')) s = s.slice(0, -1);
      const v = parseFloat(s);
      return isNaN(v) ? 0 : v;
    };
// Campos posibles en la hoja (por si cambian mayúsculas/acentos/plural)
const ALIASES = {
  reg_pct: [
    "Frecuencia Regiones","Frecuencia regiones","Frecuencia Región","Frecuencia región",
    "frecuencia_regiones","frecuencia_region"
  ],
  prov_pct: [
    "Frecuencia provincia","Frecuencia Provincia","frecuencia_provincia"
  ],
  com_pct: [
    "prct_apellido","pcrt_apellidos","Frecuencia Comuna","frecuencia_comuna"
  ],
  reg_name: ["region","Region","REGION","Nombre Región","Nombre region"],
  prov_name:["provincia","Provincia","PROVINCIA","Nombre Provincia"],
  com_name: ["comuna","Comuna","COMUNA","Nombre Comuna"],
  apellido: ["apellido","Apellido","APELLIDO"]
};

function getAny(row, keys){
  for(const k of keys){ if(row[k] != null && String(row[k]).trim() !== "") return row[k]; }
  return "";
}

    // Paletas (7 clases) para cada nivel
    const PALETAS = {
      region:    ["#d7ebff","#badaff","#9cc9ff","#7fb8ff","#62a7ff","#458fff","#2a73e0"], // azul
      provincia: ["#e2f7ee","#c6efdc","#a9e6c9","#8cddb7","#6fc5a0","#4fae85","#2f956b"], // verde
      comuna:    ["#fde6e9","#fdc9cf","#fdaaae","#fb8b8d","#f25f63","#d84349","#a92d31"]  // rojo
    };

    // Cortes fijos por nivel (en %). 8 bordes -> 7 clases.
    const BINS_BY_LEVEL = {
      region:   [0, 0.05, 0.10, 0.20, 0.40, 0.80, 1.50, Infinity], // más conservador
      provincia:[0, 0.10, 0.20, 0.40, 0.80, 1.20, 2.00, Infinity], // intermedio
      comuna:   [0, 0.15, 0.30, 0.60, 1.00, 1.50, 2.50, Infinity]  // como tu ejemplo
    };

    // Utilidades
    const getProp = (p, keys, def="—") => { for(const k of keys){ if(p && p[k]!=null && p[k]!=="") return p[k]; } return def; };

    // Color por bins (v en %, bins en %)
    function colorByBins(v, pal, bins){
      if (v==null || isNaN(v)) return pal[0];
      for (let i=0; i<bins.length-1; i++){
        if (v >= bins[i] && v < bins[i+1]) return pal[i];
      }
      return pal[pal.length-1];
    }

    // Etiquetas para la leyenda a partir de bins
    function labelsFromBins(bins){
      const fmt = x => (x===Infinity) ? "∞" : `${(+x).toLocaleString('es-CL',{maximumFractionDigits:2})}%`;
      const labs = [];
      for(let i=0;i<bins.length-1;i++){
        const a = bins[i], b = bins[i+1];
        labs.push(b===Infinity ? `>${fmt(a)}` : `${fmt(a)}–${fmt(b)}`);
      }
      return labs;
    }

    // --------- Cargar GeoJSON ---------
    Promise.all([
      fetch(`${BASE}/regiones.json`).then(r=>r.json()),
      fetch(`${BASE}/provincias.json`).then(r=>r.json()),
      fetch(`${BASE}/comunas.json`).then(r=>r.json())
    ]).then(([geoReg, geoProv, geoCom])=>{
      const styleBase = { color:"#666", weight:1, fillColor:"#ddd", fillOpacity:.6 };

      regionesGeo = L.geoJSON(geoReg, {
        pane:'pane-regiones',
        style: f => ({...styleBase, color:"#587fbf", weight:1 }),
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, reg=getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región");
          layer.bindTooltip(reg,{sticky:true,opacity:.95});
          layer.on('mouseover', ()=> layer.setStyle({weight:2}));
          layer.on('mouseout',  ()=> layer.setStyle({weight:1}));
        }
      });

      provinciasGeo = L.geoJSON(geoProv, {
        pane:'pane-provincias',
        style: f => ({...styleBase, color:"#333", weight:1 }),
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, prov=getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia");
          layer.bindTooltip(prov,{sticky:true,opacity:.95});
          layer.on('mouseover', ()=> layer.setStyle({weight:2}));
          layer.on('mouseout',  ()=> layer.setStyle({weight:1}));
        }
      });

      comunasGeo = L.geoJSON(geoCom, {
        pane:'pane-comunas',
        style: f => ({...styleBase, color:"#990000", weight:.8 }),
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, com=getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          layer.bindTooltip(com,{sticky:true,opacity:.95});
          layer.on('mouseover', ()=> layer.setStyle({weight:1.2}));
          layer.on('mouseout',  ()=> layer.setStyle({weight:.8}));
        }
      });

      updateVisibility();
      map.on('zoomend', updateVisibility);
    });

    // --------- Leer Google Sheet y construir índice ---------
    d3.csv(SHEET_CSV).then(rows=>{
      dataRows = rows;
      construirIndice();
      document.getElementById('estado').textContent = `Listo. Apellido por defecto: ${apellidoActual}`;
      actualizarPintado();
    }).catch(err=>{
      console.error(err);
      document.getElementById('estado').textContent = "No se pudo cargar el CSV. Revisa permisos del Sheet.";
    });

    // Índice: apellido → nivel → nombre normalizado → porcentaje (número)
    function construirIndice(){
  indice = { region:{}, provincia:{}, comuna:{} };

  for(const r of dataRows){
    const ap    = norm(getAny(r, ALIASES.apellido));
    if(!ap) continue;

    const regNom = norm(getAny(r, ALIASES.reg_name));
    const provNom= norm(getAny(r, ALIASES.prov_name));
    const comNom = norm(getAny(r, ALIASES.com_name));

    // Porcentajes (se parsean aunque vengan con % o coma)
    const fReg  = parsePct(getAny(r, ALIASES.reg_pct));
    const fProv = parsePct(getAny(r, ALIASES.prov_pct));
    const fCom  = parsePct(getAny(r, ALIASES.com_pct));

    if(!indice.region[ap])    indice.region[ap]    = {};
    if(!indice.provincia[ap]) indice.provincia[ap] = {};
    if(!indice.comuna[ap])    indice.comuna[ap]    = {};

    if(regNom)  indice.region[ap][regNom]     = fReg;
    if(provNom) indice.provincia[ap][provNom] = fProv;
    if(comNom)  indice.comuna[ap][comNom]     = fCom;
  }
}


    // Valor de una feature según nivel y apellido
    function valorFeature(f, nivel, ap){
      const p=f.properties||{};
      if(nivel==="region"){
        const key = norm(getProp(p,["REGION","NOM_REG","Región","NAME_1"],""));
        return (indice.region[ap]||{})[key];
      }else if(nivel==="provincia"){
        const key = norm(getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],""));
        return (indice.provincia[ap]||{})[key];
      }else{
        const key = norm(getProp(p,["COMUNA","NOM_COM","Comuna","name"],""));
        return (indice.comuna[ap]||{})[key];
      }
    }

    // Pintado según zoom + leyenda con bins por nivel
    function actualizarPintado(){
      const ap = norm(apellidoActual);
      const z = map.getZoom();
      if (z <= 6) { nivelActual="region"; }
      else if (z <= 7) { nivelActual="provincia"; }
      else { nivelActual="comuna"; }

      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];

      const pctFmt = v => (v==null || isNaN(v)) ? "0%" : `${(+v).toFixed(2).replace('.',',')}%`;

      const pintar = (geo, nivel)=>{
        if(!geo) return;
        geo.eachLayer(l=>{
          const v = valorFeature(l.feature, nivel, ap);     // número en %
          const fill = colorByBins(v, pal, bins);
          l.setStyle({ fillColor: fill, fillOpacity: .65 });
          const p=l.feature.properties||{};
          const nombre = (nivel==="region")
            ? getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región")
            : (nivel==="provincia")
              ? getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia")
              : getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          l.bindTooltip(`${nombre}<br><small>${apellidoActual}: <b>${pctFmt(v)}</b></small>`, {sticky:true,opacity:.95});
        });
      };

      if(nivelActual==="region")   pintar(regionesGeo,"region");
      if(nivelActual==="provincia")pintar(provinciasGeo,"provincia");
      if(nivelActual==="comuna")   pintar(comunasGeo,"comuna");

      actualizarLeyenda(); // usa nivelActual
      document.getElementById('estado').textContent =
        `Mostrando "${apellidoActual}" por ${nivelActual} (zoom ${z}).`;
    }

    // Visibilidad por zoom
    function updateVisibility(){
      const z = map.getZoom();
      regionesLayer.clearLayers(); provinciasLayer.clearLayers(); comunasLayer.clearLayers();
      if(map.hasLayer(regionesLayer)) map.removeLayer(regionesLayer);
      if(map.hasLayer(provinciasLayer)) map.removeLayer(provinciasLayer);
      if(map.hasLayer(comunasLayer)) map.removeLayer(comunasLayer);

      if (z <= 6) {
        if(regionesGeo){ regionesLayer.addLayer(regionesGeo); regionesLayer.addTo(map); }
      } else if (z <= 7) {
        if(provinciasGeo){ provinciasLayer.addLayer(provinciasGeo); provinciasLayer.addTo(map); }
      } else {
        if(comunasGeo){ comunasLayer.addLayer(comunasGeo); comunasLayer.addTo(map); }
      }
      actualizarPintado();
    }

    // Leyenda por nivel
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      this._div = L.DomUtil.create('div','legend');
      this.update();
      return this._div;
    };
    legend.update = function(){
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const labs = labelsFromBins(bins);
      let html = `<b>Frecuencia (%)</b><br>`;
      for(let i=0;i<labs.length;i++){
        html += `<div class="item"><span class="swatch" style="background:${pal[i]}"></span>${labs[i]}</div>`;
      }
      this._div.innerHTML = html;
    };
    legend.addTo(map);
    function actualizarLeyenda(){ legend.update(); }

    // Control de capas (opcional)
    L.control.layers(null, {
      "Regiones (zoom ≤ 6)": regionesLayer,
      "Provincias (7)": provinciasLayer,
      "Comunas (≥ 8)": comunasLayer
    }, {collapsed:true}).addTo(map);

    // Búsqueda por apellido
    document.getElementById('buscarBtn').addEventListener('click', ()=>{
      const v = document.getElementById('apellidoInput').value.trim();
      if(!v) return;
      apellidoActual = v;
      actualizarPintado();
    });
    document.getElementById('apellidoInput').addEventListener('keydown', (e)=>{
      if(e.key==="Enter") document.getElementById('buscarBtn').click();
    });
  </script>
</body>
</html>
