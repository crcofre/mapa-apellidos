<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; background:#f7f7f7; }
    .leaflet-tooltip{
      font-family:"Book Antiqua",serif; font-size:13px; font-weight:bold;
      color:#000; background:rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.2); border-radius:4px; padding:3px 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // ----------------- Mapa sin cartografía base -----------------
    const map = L.map('map', { center: [-35.6751, -71.5430], zoom: 5 });

    const BASE = "https://raw.githubusercontent.com/crcofre/mapa-apellidos/main";

    // Estilos
    const styleRegiones   = { color:"#587fbf", weight:1, fillColor:"#aecdff", fillOpacity:.55 }; // azul pálido
    const styleProvincias = { color:"#333",    weight:1, fillColor:"#76c893", fillOpacity:.55 }; // verde
    const styleComunas    = { color:"#990000", weight:.8, fillColor:"#e34a33", fillOpacity:.45 }; // rojo

    // Panes (el orden ya no importa si controlamos visibilidad por zoom)
    map.createPane('pane-regiones');
    map.createPane('pane-provincias');
    map.createPane('pane-comunas');

    // Grupos
    const regionesLayer   = L.layerGroup();
    const provinciasLayer = L.layerGroup();
    const comunasLayer    = L.layerGroup();
    let regionesGeo=null, provinciasGeo=null, comunasGeo=null;

    // Utilidad nombres de campos
    function getProp(p, keys, def="—"){ for(const k of keys){ if(p&&p[k]!=null&&p[k]!=="") return p[k]; } return def; }

    // ------- Cargar REGIONES -------
    fetch(`${BASE}/regiones.json`).then(r=>r.json()).then(geo=>{
      regionesGeo = L.geoJSON(geo,{
        pane:'pane-regiones', style:styleRegiones,
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, reg=getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región");
          layer.bindTooltip(reg,{sticky:true,opacity:.95});
        }
      });
      updateVisibility();
    });

    // ------- Cargar PROVINCIAS -------
    fetch(`${BASE}/provincias.json`).then(r=>r.json()).then(geo=>{
      provinciasGeo = L.geoJSON(geo,{
        pane:'pane-provincias', style:styleProvincias,
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, prov=getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia");
          layer.bindTooltip(prov,{sticky:true,opacity:.95});
        }
      });
      updateVisibility();
    });

    // ------- Cargar COMUNAS -------
    fetch(`${BASE}/comunas.json`).then(r=>r.json()).then(geo=>{
      comunasGeo = L.geoJSON(geo,{
        pane:'pane-comunas', style:styleComunas,
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, com=getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          layer.bindTooltip(com,{sticky:true,opacity:.95});
        }
      });
      updateVisibility();
    });

    // ------- Visibilidad por zoom -------
    function updateVisibility(){
      const z = map.getZoom();

      // limpiar
      regionesLayer.clearLayers(); provinciasLayer.clearLayers(); comunasLayer.clearLayers();
      if(map.hasLayer(regionesLayer)) map.removeLayer(regionesLayer);
      if(map.hasLayer(provinciasLayer)) map.removeLayer(provinciasLayer);
      if(map.hasLayer(comunasLayer)) map.removeLayer(comunasLayer);

      if (z <= 5) {
        if(regionesGeo){ regionesLayer.addLayer(regionesGeo); regionesLayer.addTo(map); }
      } else if (z <= 7) {
        if(provinciasGeo){ provinciasLayer.addLayer(provinciasGeo); provinciasLayer.addTo(map); }
      } else {
        if(comunasGeo){ comunasLayer.addLayer(comunasGeo); comunasLayer.addTo(map); }
      }
    }
    map.on('zoomend', updateVisibility);

    // Control (opcional)
    L.control.layers(null, {
      "Regiones (zoom ≤ 5)": regionesLayer,
      "Provincias (6–7)": provinciasLayer,
      "Comunas (≥ 8)": comunasLayer
    }, {collapsed:true}).addTo(map);
  </script>
</body>
</html>
