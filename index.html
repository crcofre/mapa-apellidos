<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Apellidos en Chile</title>

  <!-- Estilos base (ajusta si ya cargas Tailwind/Bootstrap en tu versión) -->
  <style>
    :root {
      --panel-bg: #fff;
      --panel-br: 12px;
      --panel-bd: #e7e7e7;
      --shadow: 0 6px 20px rgba(0,0,0,.08);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html, body { height: 100%; margin: 0; font-family: var(--font); color: #111; }
    #app { height: 100%; position: relative; overflow: hidden; }

    /* Contenedor del mapa (no se toca tu lógica) */
    #map { position: absolute; inset: 0; }

    /* Panel de búsqueda (se mantiene pero sin botón) */
    #search-panel {
      position: absolute; top: 12px; left: 12px; z-index: 500;
      background: var(--panel-bg); border: 1px solid var(--panel-bd);
      border-radius: var(--panel-br); box-shadow: var(--shadow);
      padding: 10px; width: 520px; max-width: calc(100% - 24px);
    }
    #search-panel label { display: block; font-weight: 700; margin-bottom: 6px; }
    #apellido-input {
      width: 100%; height: 36px; border-radius: 8px; border: 1px solid #d0d7de;
      padding: 0 10px; font-size: 14px;
    }
    /* El botón Buscar se oculta (manteniendo el DOM por si tu script lo consulta) */
    #buscar-btn { display: none !important; }

    /* Panel “estado” opcional bajo el buscador */
    #status-text { margin-top: 8px; font-size: 12px; color: #666; }

    /* Leyenda + Nivel (mismo ancho) */
    #legend-wrapper {
      position: absolute; right: 16px; bottom: 16px; z-index: 500;
      display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
    }
    .panel {
      background: var(--panel-bg); border: 1px solid var(--panel-bd);
      border-radius: var(--panel-br); box-shadow: var(--shadow);
      padding: 10px 12px; width: 220px; /* ancho base de la leyenda */
    }
    #level-controls.panel { width: 220px; } /* mismo ancho que la leyenda */
    #level-controls .title { font-weight: 700; margin-bottom: 6px; font-size: 13px; }
    #level-controls label { display: block; margin: 4px 0; font-size: 12.5px; }

    /* Ocultar controles de zoom y logs, sin tocar tu mapa */
    .leaflet-control-zoom,
    .mapboxgl-ctrl-zoom,
    .mapboxgl-ctrl-group,
    .zoom-controls,
    #zoom-controls { display: none !important; }
    #logs, #log, .debug-log, .console-overlay { display: none !important; }

    /* Quitar outlines en SVG (acuerdo previo) */
    svg:focus, svg *:focus, svg:focus-visible, svg *:focus-visible { outline: none !important; }
  </style>

  <!-- Si tu archivo original ya incluía librerías (Leaflet, D3, etc.), puedes volver a pegarlas dentro del bloque JS original -->
</head>
<body>
  <div id="app">
    <!-- Mapa -->
    <div id="map" aria-label="Mapa de Apellidos"></div>

    <!-- Buscador (sin botón) -->
    <div id="search-panel" class="panel">
      <label for="apellido-input">Consulta tu apellido</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="apellido-input" type="text" placeholder="Ej: MUÑOZ" autocomplete="off" />
        <!-- Botón oculto, se deja por compatibilidad con tu JS -->
        <button id="buscar-btn" type="button">Buscar</button>
      </div>
      <div id="status-text"></div>
    </div>

    <!-- Leyenda + Nivel (Nivel va arriba de Frecuencia, con mismo ancho) -->
    <div id="legend-wrapper">
      <!-- Nivel de visualización (se reubica aquí; radios iguales a tu versión) -->
      <div id="level-controls" class="panel" style="display: none;">
        <div class="title">Nivel de visualización</div>
        <label><input type="radio" name="nivel" value="auto"> Auto (según zoom)</label>
        <label><input type="radio" name="nivel" value="region"> Región</label>
        <label><input type="radio" name="nivel" value="provincia"> Provincia</label>
        <label><input type="radio" name="nivel" value="comuna" checked> Comuna</label>
      </div>

      <!-- Leyenda de Frecuencia: pega aquí tu leyenda si la tienes inline,
           o deja este contenedor para que tu JS la inyecte como antes -->
      <div id="legend" class="panel">
        <!-- === TU LEYENDA ORIGINAL (FRECUENCIA) SE MANTIENE ===
             Si tu script la genera dinámicamente, este contenedor conserva el mismo id/class. -->
        <div id="legend-title" style="font-weight:700;margin-bottom:8px;">Frecuencia (%)</div>
        <div id="legend-scale">
          <!-- Si tu leyenda es dinámica, este bloque se reemplaza. Este markup es de respaldo. -->
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#eaf4ef;border:1px solid #cdd;vertical-align:middle;"></span><span style="font-size:12px;">0%–0,1%</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#d8efe3;border:1px solid #cdd;"></span><span style="font-size:12px;">0,1%–0,2%</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#c4e9d6;border:1px solid #cdd;"></span><span style="font-size:12px;">0,2%–0,4%</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#b0e2c8;border:1px solid #cdd;"></span><span style="font-size:12px;">0,4%–0,8%</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#9bdbba;border:1px solid #cdd;"></span><span style="font-size:12px;">0,8%–1,2%</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#86d4ad;border:1px solid #cdd;"></span><span style="font-size:12px;">1,2%–2%</span></div>
          <div style="display:flex;gap:6px;align-items:center;margin:4px 0;"><span style="display:inline-block;width:16px;height:10px;background:#71cda0;border:1px solid #cdd;"></span><span style="font-size:12px;">&gt;2%</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       BLOQUE JS
       ========================= -->
  <script>
  /* ============================================================
     === TU JS ORIGINAL (SIN CAMBIOS) ============================
     Pega aquí TODO el contenido JS de tu index actual (funciones,
     creación del mapa, carga de shards, listeners, etc.).
     NO elimines nada. No cambies nombres de funciones ni IDs.
     ============================================================ */

  // ------------------------------------------------------------
  // (1) PARCHE NO INTRUSIVO: Ocultar logs y controles de zoom
  // ------------------------------------------------------------
  (function(){
    // Silenciar overlays de log si existen
    ["logs","log"].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = "none"; });
    // Quitar controles +/- si quedaron renderizados por la lib
    const zooms = document.querySelectorAll('.leaflet-control-zoom,.mapboxgl-ctrl-zoom,.mapboxgl-ctrl-group,.zoom-controls,#zoom-controls');
    zooms.forEach(z => z.parentNode && z.parentNode.removeChild(z));
  })();

  // ------------------------------------------------------------
  // (2) Mover “Nivel de visualización” sobre la leyenda
  //     - Si ya existía en otro lugar, lo reubicamos aquí
  // ------------------------------------------------------------
  (function(){
    // Busca radios existentes por nombres/ids típicos de tu versión
    let level = document.getElementById('level-controls');
    if (!level) {
      // Si en tu código original hay un contenedor con los radios (ej. #level, #niveles)
      level = document.querySelector('#level, #niveles, .level-controls');
      if (level) {
        level.id = 'level-controls';
        level.classList.add('panel');
      }
    }
    const legendWrapper = document.getElementById('legend-wrapper');
    if (level && legendWrapper && !legendWrapper.contains(level)) {
      legendWrapper.prepend(level);
    }
    // Mostrar (por si estaba oculto)
    if (level) level.style.display = 'block';
  })();

  // ------------------------------------------------------------
  // (3) Búsqueda automática (sin botón)
  //     - Llama a tu función existente para cargar/pintar el apellido.
  //       NOMBRES POSIBLES: updateMapForSurname / loadSurname / setSurname
  // ------------------------------------------------------------
  (function(){
    // Debounce helper
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), ms); }; }

    // Detecta el input (tu id puede ser otro: ajusto selectores seguros)
    const input = document.getElementById('apellido-input')
               || document.getElementById('search-input')
               || document.querySelector('input[name="apellido"], select[name="apellido"]');

    if (!input) return;

    async function cargar(ap) {
      if (!ap || !ap.trim()) return;
      const apellido = ap.trim().toUpperCase();

      // Llamamos a la función que ya usas en tu código
      if (typeof window.updateMapForSurname === 'function') {
        await window.updateMapForSurname(apellido);
      } else if (typeof window.loadSurname === 'function') {
        await window.loadSurname(apellido);
      } else if (typeof window.setSurname === 'function') {
        await window.setSurname(apellido);
      }

      const status = document.getElementById('status-text');
      if (status) status.textContent = `Mostrando "${apellido}"`;
    }

    const onType = debounce(()=>cargar(input.value), 250);
    input.addEventListener('input', onType);
    input.addEventListener('change', ()=>cargar(input.value));
    input.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });

    // Si el input ya trae valor (ej. precargado por querystring), dibuja
    if (input.value && input.value.trim()) cargar(input.value);
  })();

  // ------------------------------------------------------------
  // (4) Cambios de “Nivel de visualización”
  //     - Mantiene tus nombres; si tu código ya escucha estos radios,
  //       no hace falta nada. Si no, reemitimos el evento a tus funciones.
  // ------------------------------------------------------------
  (function(){
    const levelBox = document.getElementById('level-controls');
    if (!levelBox) return;

    levelBox.addEventListener('change', (e)=>{
      if (e.target && e.target.name === 'nivel') {
        const v = e.target.value; // 'auto' | 'region' | 'provincia' | 'comuna'
        // Re-disparamos a tu API si existe:
        if (typeof window.setLevel === 'function') window.setLevel(v);
        if (typeof window.updateLevel === 'function') window.updateLevel(v);
      }
    });
  })();
  </script>
</body>
</html>
