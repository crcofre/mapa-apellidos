<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Provincias y Comunas de Chile</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
    .info {
      background: rgba(255,255,255,0.9);
      padding: 8px 10px;
      border-radius: 6px;
      font-family: "Book Antiqua", serif;
      line-height: 1.3;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
    }
    .leaflet-control-layers-expanded {
      font-family: "Book Antiqua", serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --------- Utilidades ----------
    function getProp(props, keys, fallback = "—") {
      // Devuelve el primer campo existente según una lista de posibles nombres
      for (const k of keys) {
        if (props && props[k] != null && props[k] !== "") return props[k];
      }
      return fallback;
    }

    // --------- Mapa base ----------
    const map = L.map('map', {
      zoomControl: true
    }).setView([-35.6751, -71.5430], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // --------- Controles e info ----------
    const info = L.control({position: 'topright'});
    info.onAdd = function() {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
    };
    info.update = function(txt) {
      this._div.innerHTML = txt || '<b>Mapa de Apellidos</b><br>• Provincias en verde<br>• Comunas al acercar (zoom ≥ 8)';
    };
    info.addTo(map);

    // Grupos de capas
    const provinciasLayer = L.layerGroup().addTo(map);  // visible por defecto
    const regionesLayer   = L.layerGroup();             // opcional
    const comunasLayer    = L.layerGroup();             // aparece con zoom

    // --------- Estilos ----------
    const styleProvincias = {
      color: "#333",
      weight: 1,
      fillColor: "#76c893",  // verde
      fillOpacity: 0.55
    };

    const styleRegiones = {
      color: "#1b4d3e",
      weight: 2.2,
      fillOpacity: 0
    };

    const styleComunas = {
      color: "#444",
      weight: 0.8,
      fillColor: "#a1d99b",
      fillOpacity: 0.45
    };

    // --------- Carga de GeoJSON ----------
    const BASE = "https://raw.githubusercontent.com/crcofre/mapa-apellidos/main";

    // Provincias
    fetch(`${BASE}/provincias.json`)
      .then(r => {
        if (!r.ok) throw new Error("No se pudo cargar provincias.json");
        return r.json();
      })
      .then(geo => {
        L.geoJSON(geo, {
          style: styleProvincias,
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const nomProv = getProp(p, ["NOM_PROV","PROVINCIA","Provincia","provincia","NAME_2","name"], "Provincia");
            const nomReg  = getProp(p, ["NOM_REG","REGION","Región","region","NAME_1"], "Región");
            layer.bindPopup(`<b>Provincia:</b> ${nomProv}<br><b>Región:</b> ${nomReg}`);
            layer.on('click', () => {
              map.fitBounds(layer.getBounds(), { padding: [20,20] });
            });
          }
        }).addTo(provinciasLayer);
      })
      .catch(err => console.warn("Error al cargar provincias:", err));

    // Regiones (opcional)
    fetch(`${BASE}/regiones.json`)
      .then(r => {
        if (!r.ok) throw new Error("No se pudo cargar regiones.json (opcional)");
        return r.json();
      })
      .then(geo => {
        L.geoJSON(geo, {
          style: styleRegiones,
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const nomReg = getProp(p, ["NOM_REG","REGION","Región","region","NAME_1"], "Región");
            layer.bindPopup(`<b>Región:</b> ${nomReg}`);
          }
        }).addTo(regionesLayer);
      })
      .catch(err => console.info("Regiones no cargadas (opcional):", err.message));

    // Comunas (visibles con zoom alto)
    let comunasGeoLayer = null;
    fetch(`${BASE}/comunas.json`)
      .then(r => {
        if (!r.ok) throw new Error("No se pudo cargar comunas.json");
        return r.json();
      })
      .then(geo => {
        comunasGeoLayer = L.geoJSON(geo, {
          style: styleComunas,
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const nomCom = getProp(p, ["NOM_COM","COMUNA","Comuna","comuna","name"], "Comuna");
            const nomProv = getProp(p, ["NOM_PROV","PROVINCIA","Provincia","provincia","NAME_2"], "Provincia");
            const nomReg  = getProp(p, ["NOM_REG","REGION","Región","region","NAME_1"], "Región");
            layer.bindPopup(`<b>Comuna:</b> ${nomCom}<br><b>Provincia:</b> ${nomProv}<br><b>Región:</b> ${nomReg}`);
            layer.on('click', () => map.fitBounds(layer.getBounds(), { padding: [20,20] }));
          }
        });
        // No la agregamos aún: se maneja con el zoom
        updateComunasVisibility();
      })
      .catch(err => console.error("Error al cargar comunas:", err));

    // --------- Mostrar/Ocultar comunas según zoom ----------
    const ZOOM_MIN_COMUNAS = 8;
    function updateComunasVisibility() {
      if (!comunasGeoLayer) return;
      if (map.getZoom() >= ZOOM_MIN_COMUNAS) {
        if (!map.hasLayer(comunasLayer)) comunasLayer.addTo(map);
        if (!comunasLayer.hasLayer(comunasGeoLayer)) comunasGeoLayer.addTo(comunasLayer);
        info.update('<b>Mapa de Apellidos</b><br>Comunas visibles (zoom ≥ 8).');
      } else {
        if (comunasLayer.hasLayer(comunasGeoLayer)) comunasLayer.removeLayer(comunasGeoLayer);
        if (map.hasLayer(comunasLayer)) map.removeLayer(comunasLayer);
        info.update('<b>Mapa de Apellidos</b><br>Provincias en verde. Acércate para ver comunas (zoom ≥ 8).');
      }
    }
    map.on('zoomend', updateComunasVisibility);

    // --------- Control de capas (por si lo quieres mostrar) ----------
    const overlays = {
      "Provincias (verde)": provinciasLayer,
      "Regiones (borde)": regionesLayer,
      "Comunas (zoom ≥ 8)": comunasLayer
    };
    L.control.layers(null, overlays, { collapsed: true }).addTo(map);
  </script>
</body>
</html>
