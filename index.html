<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; background:#f7f7f7; }
    .leaflet-tooltip{
      font-family:"Book Antiqua",serif; font-size:13px; font-weight:bold;
      color:#000; background:rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.2); border-radius:4px; padding:3px 6px;
    }
    path.leaflet-interactive:focus { outline:none; filter:drop-shadow(0 0 2px rgba(0,0,0,.4)); }

    .search-ui{
      position:absolute; top:12px; left:12px; z-index:1000;
      background:#ffffffeb; backdrop-filter: blur(3px);
      border:1px solid #ddd; border-radius:10px; padding:10px 12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      max-width: min(92vw, 420px);
    }
    .search-ui h3{ margin:0 0 6px 0; font-size:14px; font-weight:700; }
    .search-ui .row{ display:flex; gap:6px; }
    .search-ui input{ flex:1; padding:6px 8px; font-size:14px; border:1px solid #ccc; border-radius:8px; }
    .search-ui button{
      padding:6px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:600;
      background:#0b5ed7; color:#fff;
    }
    .search-ui small{ display:block; margin-top:6px; color:#555; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .legend{
      line-height:16px; color:#333; background:#fff; padding:8px 10px;
      border-radius:8px; border:1px solid #ddd; box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; font-size:12px;
    }
    .legend .item{ display:flex; align-items:center; gap:6px; }
    .legend .swatch{ width:18px; height:12px; border:1px solid #999; }
    .legend b{ display:block; margin-bottom:4px; }
  </style>
</head>
<body>
  <!-- UI de búsqueda -->
  <div class="search-ui">
    <h3>Consulta tu apellido</h3>
    <div class="row">
      <input id="apellidoInput" type="text" placeholder="Ej.: Cisternas" list="apellidosList" autocomplete="off" />
      <button id="btn-buscar">Buscar</button>
    </div>
    <datalist id="apellidosList"></datalist>
    <small id="estado">Cargando…</small>
  </div>

  <div id="map"></div>

  <script>
    // ======================= CONFIG =======================
    // Base del sitio (GitHub Pages)
    const SITE_BASE = "https://crcofre.github.io/mapa-apellidos";

    // Datos estáticos
    const MANIFEST_URL = `${SITE_BASE}/data/apellidos_manifest.json`; // slug -> shard
    const SHARDS_BASE  = `${SITE_BASE}/data/`;                 // carpeta con apellidos_xx.json
    const INDEX_URL    = `${SITE_BASE}/data/index_apellidos.json`;    // [{apellido, slug}, ...]

    // GeoJSON (en la raíz del repo)
    const GEO_REG = `${SITE_BASE}/regiones.json`;
    const GEO_PRO = `${SITE_BASE}/provincias.json`;
    const GEO_COM = `${SITE_BASE}/comunas.json`;

    // Paletas y bins
    const PALETAS = {
      region:    ["#d7ebff","#badaff","#9cc9ff","#7fb8ff","#62a7ff","#458fff","#2a73e0"], // azul
      provincia: ["#e2f7ee","#c6efdc","#a9e6c9","#8cddb7","#6fc5a0","#4fae85","#2f956b"], // verde
      comuna:    ["#fde6e9","#fdc9cf","#fdaaae","#fb8b8d","#f25f63","#d84349","#a92d31"]  // rojo
    };
    const BINS_BY_LEVEL = {
      region:   [0, 0.05, 0.10, 0.20, 0.40, 0.80, 1.50, Infinity],
      provincia:[0, 0.10, 0.20, 0.40, 0.80, 1.20, 2.00, Infinity],
      comuna:   [0, 0.15, 0.30, 0.60, 1.00, 1.50, 2.50, Infinity]
    };

    // ======================= UTILIDADES =======================
    const norm = s => {
      if (!s) return "";
      let t = String(s).normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ").trim().toUpperCase();
      t = t.replace(/^\s*\d+\s*[\.\-]?\s*/, ""); // prefijo numérico
      t = t.replace(/^(REGION|PROVINCIA|DEPARTAMENTO)\s+(DEL\s+|DE\s+)?/, "").replace(/^(DEL|DE)\s+/, "");
      return t.trim();
    };
    const slugify = s => norm(s).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    const getProp = (p, keys, def="—") => { for(const k of keys){ if(p && p[k]!=null && p[k]!=="") return p[k]; } return def; };

    function colorByBins(v, pal, bins){
      if (v==null || isNaN(v)) return pal[0];
      for (let i=0; i<bins.length-1; i++){
        if (v >= bins[i] && v < bins[i+1]) return pal[i];
      }
      return pal[pal.length-1];
    }
    function labelsFromBins(bins){
      const fmt = x => (x===Infinity) ? "∞" : `${(+x).toLocaleString('es-CL',{maximumFractionDigits:2})}%`;
      const labs = [];
      for(let i=0;i<bins.length-1;i++){
        const a=bins[i], b=bins[i+1];
        labs.push(b===Infinity ? `>${fmt(a)}` : `${fmt(a)}–${fmt(b)}`);
      }
      return labs;
    }

    // ======================= MAPA =======================
    const map = L.map('map', { center: [-35.6751, -71.5430], zoom: 5, minZoom: 4, maxZoom: 12 });

    const regionesLayer   = L.layerGroup().addTo(map);
    const provinciasLayer = L.layerGroup().addTo(map);
    const comunasLayer    = L.layerGroup().addTo(map);

    let regionesGeo=null, provinciasGeo=null, comunasGeo=null;

    // Leyenda
    let nivelActual = "region";
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      this._div = L.DomUtil.create('div','legend');
      this.update();
      return this._div;
    };
    legend.update = function(){
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const labs = labelsFromBins(bins);
      let html = `<b>Frecuencia (%)</b><br>`;
      for(let i=0;i<labs.length;i++){
        html += `<div class="item"><span class="swatch" style="background:${pal[i]}"></span>${labs[i]}</div>`;
      }
      this._div.innerHTML = html;
    };
    legend.addTo(map);
    function actualizarLeyenda(){ legend.update(); }

    // Cargar GeoJSON
    Promise.all([
      fetch(GEO_REG).then(r=>r.json()),
      fetch(GEO_PRO).then(r=>r.json()),
      fetch(GEO_COM).then(r=>r.json())
    ]).then(([geoReg, geoProv, geoCom])=>{
      const styleBase = { color:"#666", weight:1, fillColor:"#ddd", fillOpacity:.6 };

      regionesGeo = L.geoJSON(geoReg, {
        style: f => ({...styleBase, color:"#587fbf", weight:1 }),
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, reg=getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región");
          layer.bindTooltip(reg,{sticky:true,opacity:.95});
          layer.on('mouseover', ()=> layer.setStyle({weight:2}));
          layer.on('mouseout',  ()=> layer.setStyle({weight:1}));
        }
      }).addTo(regionesLayer);

      provinciasGeo = L.geoJSON(geoProv, {
        style: f => ({...styleBase, color:"#333", weight:1 }),
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, prov=getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia");
          layer.bindTooltip(prov,{sticky:true,opacity:.95});
          layer.on('mouseover', ()=> layer.setStyle({weight:2}));
          layer.on('mouseout',  ()=> layer.setStyle({weight:1}));
        }
      }).addTo(provinciasLayer);

      comunasGeo = L.geoJSON(geoCom, {
        style: f => ({...styleBase, color:"#990000", weight:.8 }),
        onEachFeature:(f,layer)=>{
          const p=f.properties||{}, com=getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          layer.bindTooltip(com,{sticky:true,opacity:.95});
          layer.on('mouseover', ()=> layer.setStyle({weight:1.2}));
          layer.on('mouseout',  ()=> layer.setStyle({weight:.8}));
        }
      }).addTo(comunasLayer);

      updateVisibility();
      map.on('zoomend', updateVisibility);
    });

    function updateVisibility(){
      const z = map.getZoom();
      regionesLayer.clearLayers(); provinciasLayer.clearLayers(); comunasLayer.clearLayers();
      if (z <= 6) { regionesLayer.addLayer(regionesGeo);  nivelActual="region"; }
      else if (z <= 7) { provinciasLayer.addLayer(provinciasGeo); nivelActual="provincia"; }
      else { comunasLayer.addLayer(comunasGeo); nivelActual="comuna"; }
      actualizarLeyenda();
      if (window.__ultimoApellido) pintar(window.__ultimoApellido);
    }

    // ======================= CARGA DE DATOS (SHARDS) =======================
    let MANIFEST = null;           // { slug : "apellidos_ab.json", ... }
    let INDICE   = [];             // [{apellido, slug}, ...]

    // autocompletar
    function poblarDatalist(){
      const dl = document.getElementById('apellidosList');
      dl.innerHTML = INDICE.map(x=>`<option value="${x.apellido}"></option>`).join('');
    }

    async function boot(){
      const [man, idx] = await Promise.all([
        fetch(MANIFEST_URL).then(r=>r.json()),
        fetch(INDEX_URL).then(r=>r.json())
      ]);
      MANIFEST = man;
      INDICE = idx;
      poblarDatalist();
      document.getElementById('estado').textContent = "Listo. Escribe tu apellido y presiona Buscar.";
    }

    // descarga un apellido: busca su shard, lo lee y devuelve el objeto del apellido
    async function cargarApellido(apellidoTexto){
      const slug = (INDICE.find(x => x.apellido.toUpperCase()===apellidoTexto.toUpperCase())?.slug) || slugify(apellidoTexto);
      const shard = MANIFEST[slug];
      if (!shard) throw new Error("Apellido no disponible.");
      const dataShard = await fetch(SHARDS_BASE + shard).then(r=>r.json());
      const data = dataShard[slug];
      if (!data) throw new Error("No encontré el apellido dentro del shard.");
      return data;  // { apellido, comunas:[{comuna,provincia,region,prct_apellido,freq_prov,freq_reg,...}], ...}
    }

    // ======================= PINTADO =======================
    function construirTablasValor(data){
      const reg = {}, prov = {}, com = {};
      for (const r of data.comunas || []){
        // comuna: clave por nombre normalizado (más robusto con distintos GeoJSON)
        const kCom = norm(r.comuna);
        com[kCom] = (r.prct_apellido ?? 0);

        // provincia / región: mismas tasas en toda la unidad
        if (r.provincia!=null) {
          const kProv = norm(r.provincia);
          if (!(kProv in prov) && r.freq_prov!=null) prov[kProv] = r.freq_prov;
        }
        if (r.region!=null) {
          const kReg = norm(r.region);
          if (!(kReg in reg) && r.freq_reg!=null) reg[kReg] = r.freq_reg;
        }
      }
      return {reg, prov, com};
    }

    function valorFeature(f, nivel, tablas){
      const p = f.properties || {};
      if (nivel==="region"){
        const key = norm(getProp(p,["REGION","NOM_REG","Región","NAME_1"],""));
        return tablas.reg[key];
      }else if (nivel==="provincia"){
        const key = norm(getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],""));
        return tablas.prov[key];
      }else{
        const key = norm(getProp(p,["COMUNA","NOM_COM","Comuna","name"],""));
        return tablas.com[key];
      }
    }

    function pintar(data){
      window.__ultimoApellido = data; // para repintar al cambiar zoom
      const tablas = construirTablasValor(data);
      const pal  = PALETAS[nivelActual];
      const bins = BINS_BY_LEVEL[nivelActual];
      const pctFmt = v => (v==null || isNaN(v)) ? "0%" : `${(+v).toFixed(2).replace('.',',')}%`;

      const pintarCapa = (geo, nivel)=>{
        if (!geo) return;
        geo.eachLayer(l=>{
          const v = valorFeature(l.feature, nivel, tablas);
          l.setStyle({ fillColor: colorByBins(v, pal, bins), fillOpacity:.65 });
          const p=l.feature.properties||{};
          const nombre = (nivel==="region")
            ? getProp(p,["REGION","NOM_REG","Región","NAME_1"],"Región")
            : (nivel==="provincia")
              ? getProp(p,["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"],"Provincia")
              : getProp(p,["COMUNA","NOM_COM","Comuna","name"],"Comuna");
          l.bindTooltip(`${nombre}<br><small>${data.apellido}: <b>${pctFmt(v)}</b></small>`, {sticky:true,opacity:.95});
        });
      };

      const z = map.getZoom();
      if (z <= 6) pintar(regionesGeo,"region");
      else if (z <= 7) pintar(provinciasGeo,"provincia");
      else pintar(comunasGeo,"comuna");

      document.getElementById('estado').textContent = `Mostrando "${data.apellido}" (${nivelActual}).`;
    }

    // ======================= UI =======================
    async function onBuscar(){
      const v = document.getElementById('apellidoInput').value.trim();
      if (!v) return;
      document.getElementById('estado').textContent = `Cargando "${v}"…`;
      try{
        const data = await cargarApellido(v);
        pintar(data);
      }catch(e){
        console.error(e);
        document.getElementById('estado').textContent = e.message;
      }
    }
    document.getElementById('btn-buscar').addEventListener('click', onBuscar);
    document.getElementById('apellidoInput').addEventListener('keydown', e=>{ if(e.key==="Enter") onBuscar(); });

    // Boot
    boot();
  </script>
</body>
</html>
