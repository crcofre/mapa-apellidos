<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de apellidos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel {
      position: absolute; z-index: 1000; top: 16px; left: 16px;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      padding: 12px; width: 320px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    }
    .panel h3 { margin: 0 0 8px 0; font-size: 18px; }
    .row { display:flex; gap:8px; }
    .row input { flex:1; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; }
    .row button { padding:8px 12px; border:0; background:#1d4ed8; color:#fff; border-radius:8px; font-weight:600; cursor:pointer; }
    .log {
      margin-top: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px; color:#111827; background:#f9fafb; border:1px dashed #d1d5db;
      height: 140px; overflow:auto; border-radius:8px; padding:8px;
    }
    .pill { display:inline-block; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:11px; }
    .legend { position:absolute; right:16px; bottom:16px; background:#fff; padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; font-size:12px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Consulta tu apellido</h3>
    <div class="row">
      <input id="q" placeholder="Ej.: Cisternas" />
      <button id="go">Buscar</button>
    </div>
    <div id="status" style="margin-top:6px; font-size:13px; color:#6b7280;">Cargando…</div>
    <div class="log" id="log"></div>
  </div>

  <div class="legend" id="legend" style="display:none">
    <div><span class="pill">Intensidad</span></div>
    <div>Más claro = menor; más oscuro = mayor</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <script>
  // ===== Config =====
  const DATA_DIR = 'data';
  const MANIFEST_URL = `${DATA_DIR}/apellidos_manifest.json`; // <-- tu archivo adjunto
  const REGIONES_URL  = 'regiones.json';
  const PROVINCIAS_URL= 'provincias.json';
  const COMUNAS_URL   = 'comunas.json';

  // ===== UI helpers =====
  const $q = (s) => document.querySelector(s);
  const $log = $q('#log');
  const log = (...args) => { console.log(...args); $log.append(document.createTextNode(time(), ' ')); $log.append(document.createTextNode(args.map(a => safe(a)).join(' '))); $log.append(document.createElement('br')); $log.scrollTop = $log.scrollHeight; }
  const err = (...args) => { console.error(...args); $log.append(document.createTextNode(time(), ' ')); const span = document.createElement('span'); span.style.color = '#b91c1c'; span.textContent = args.map(a => safe(a)).join(' '); $log.append(span); $log.append(document.createElement('br')); $log.scrollTop = $log.scrollHeight; }
  const setStatus = (t) => { $q('#status').textContent = t; }
  const time = () => `[${new Date().toLocaleTimeString()}]`;
  const safe = (v) => (typeof v === 'string' ? v : JSON.stringify(v));

  // ===== Normalización de apellidos (claves del manifest están en minúsculas, sin tildes) =====
  const slugify = (s) => {
    if (!s) return '';
    return s
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g, '') // quitar diacríticos
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9\s\-']/g, '')  // dejar letras/números/espacios simples
      .replace(/\s+/g, ' ')            // colapsar espacios
      .replace(/^\s+|\s+$/g, '')       // trim
      .replace(/\s+/g, ' ');           // (manifest usa claves sin guiones; p.ej. "abarca")
  };

  // ===== Estado global mínimo =====
  let map, comunasLayer, manifest = null, geo = { regiones:null, provincias:null, comunas:null };

  // ===== Capa base =====
  function initMap() {
    map = L.map('map', { zoomControl: true });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 12, minZoom: 4, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    map.setView([-35.675, -71.542], 5);
  }

  // ===== Cargar GeoJSON base =====
  async function loadBaseGeo() {
    geo.regiones  = await fetchJSON(REGIONES_URL, 'regiones');
    geo.provincias= await fetchJSON(PROVINCIAS_URL, 'provincias');
    geo.comunas   = await fetchJSON(COMUNAS_URL, 'comunas');

    if (!geo.comunas) throw new Error('No se pudo cargar comunas.json');

    // Dibujamos comunas (sin datos aún)
    if (comunasLayer) map.removeLayer(comunasLayer);
    comunasLayer = L.geoJSON(geo.comunas, {
      style: { color:'#b91c1c', weight: 0.7, fillColor:'#e5e7eb', fillOpacity:0.9 }
    }).addTo(map);
    log('OK capas base dibujadas. comunas features:', geo.comunas.features?.length ?? '¿?');
  }

  // ===== Cargar manifest =====
  async function loadManifest() {
    manifest = await fetchJSON(MANIFEST_URL, 'manifest');
    if (!manifest) throw new Error('manifest vacío o no encontrado');
    // Sanity check
    const sample = Object.keys(manifest).slice(0, 3).map(k => `${k}→${manifest[k]}`).join(', ');
    log('Manifest cargado. Ejemplos:', sample);
  }

  // ===== Utilitario fetch JSON con logs =====
  async function fetchJSON(url, tag) {
    try {
      log(`fetch → ${tag}:`, url);
      const res = await fetch(url, { cache: 'no-store' });
      log(`respuesta ${tag}:`, res.status);
      if (!res.ok) throw new Error(`${tag} HTTP ${res.status}`);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if (!ct.includes('application/json')) {
        // Cuando hay “Unexpected token <” suele ser porque vino un HTML
        err(`ADVERTENCIA: content-type de ${tag} es "${ct}". ¿Ruta correcta?`);
      }
      const data = await res.json();
      log(`OK parse ${tag}`);
      return data;
    } catch (e) {
      err(`Error cargando ${tag}:`, e.message);
      return null;
    }
  }

  // ===== Buscar y pintar =====
  async function runSearch() {
    const raw = $q('#q').value;
    const key = slugify(raw);
    if (!key) { setStatus('Ingresa un apellido.'); return; }
    if (!manifest) { setStatus('Manifest no disponible.'); err('Manifest no cargado.'); return; }

    setStatus('Buscando en manifest…');
    const shardFile = manifest[key];
    log('apellido:', raw, '→ clave:', key, '→ archivo:', shardFile || '(no encontrado)');

    if (!shardFile) {
      setStatus('No encontré ese apellido en el índice.');
      return;
    }

    setStatus(`Cargando shard: ${shardFile}…`);
    const shard = await fetchJSON(`${DATA_DIR}/${shardFile}`, 'shard');
    if (!shard) { setStatus('No se pudo cargar el shard.'); return; }

    // Detectar formato del shard
    let entry = null;
    if (Array.isArray(shard)) {
      log('Shard es un arreglo. Busco objeto con clave del apellido…');
      entry = shard.find(o =>
        (typeof o?.apellido === 'string' && slugify(o.apellido) === key) ||
        (typeof o?.apellido_slug === 'string' && o.apellido_slug === key) ||
        (typeof o?.key === 'string' && o.key === key)
      );
    } else if (typeof shard === 'object' && shard !== null) {
      log('Shard es un objeto. Intento tomar directamente shard[key]…');
      entry = shard[key] || shard[key?.toLowerCase?.()] || shard[key?.toUpperCase?.()];
      // algunos shards podrían estar agrupados por primera letra:
      if (!entry && key) {
        const first = key[0];
        if (shard[first] && typeof shard[first] === 'object') {
          entry = shard[first][key];
          if (entry) log('Entrada encontrada en subobjeto por primera letra.');
        }
      }
    }

    if (!entry) {
      setStatus('No encontré datos del apellido dentro del shard (ver logs).');
      err('Entrada no encontrada en shard para clave:', key);
      return;
    }

    // Intentamos deducir un diccionario comuna_id → valor
    let byComuna = null;
    if (entry.comunas && typeof entry.comunas === 'object') {
      byComuna = entry.comunas;
    } else if (entry.data && typeof entry.data === 'object') {
      byComuna = entry.data;
    } else if (entry.mapa && typeof entry.mapa === 'object') {
      byComuna = entry.mapa;
    } else if (typeof entry === 'object' && !Array.isArray(entry)) {
      // último intento: quizá la propia entrada es el mapping
      const keys = Object.keys(entry);
      const seemsComunas = keys.length && keys.every(k => /^\d+$/.test(k));
      if (seemsComunas) byComuna = entry;
    }

    if (!byComuna) {
      setStatus('El formato del shard no es reconocible (ver logs).');
      err('No pude inferir mapping comuna_id→valor. Entrada:', entry);
      return;
    }

    // Pintamos
    paint(byComuna, raw || key);
  }

  function paint(byComuna, label) {
    // Tomar valores numéricos
    const vals = Object.values(byComuna).map(v => Number(v)).filter(n => Number.isFinite(n));
    const max = Math.max(...vals, 0);
    const min = Math.min(...vals, 0);
    log('Rango valores:', {min, max, n: vals.length});

    // Re-estilo de comunas
    comunasLayer.setStyle(f => {
      const id = f.properties?.id || f.properties?.cut || f.properties?.codigo || f.properties?.Cod_Comuna || f.properties?.codigo_comuna;
      const v = Number(byComuna[id] ?? byComuna[String(id)] ?? NaN);
      const t = Number.isFinite(v) ? v : null;
      return {
        color:'#b91c1c', weight: 0.7,
        fillColor: t==null ? '#e5e7eb' : shade(t, min, max),
        fillOpacity: t==null ? 0.7 : 0.9
      };
    });

    comunasLayer.eachLayer(layer => {
      const f = layer.feature;
      const id = f.properties?.id || f.properties?.cut || f.properties?.codigo || f.properties?.Cod_Comuna || f.properties?.codigo_comuna;
      const nm = f.properties?.name || f.properties?.Nombre || f.properties?.Comuna || f.properties?.NOM_COM;
      const v = byComuna[id] ?? byComuna[String(id)];
      layer.bindTooltip(`${nm ?? 'Comuna'} (${id ?? 's/i'})<br>${label}: <b>${v ?? 's/dato'}</b>`, { sticky:true });
    });

    setStatus(`Listo: ${label}. Coloreadas ${Object.keys(byComuna).length} comunas.`);
    $q('#legend').style.display = 'block';
  }

  // color simple
  function shade(v, min, max) {
    if (max === min) return '#082f49'; // caso borde
    const t = (v - min) / (max - min); // 0..1
    // escala azul (claro→oscuro)
    const c = Math.floor(255 - (t * 160)); // 255→95
    return `rgb(${c},${c+15},255)`;
  }

  // ===== Boot =====
  async function boot() {
    try {
      initMap();
      setStatus('Cargando capas base…');
      await loadBaseGeo();

      setStatus('Cargando índice de apellidos…');
      await loadManifest();

      setStatus('Listo. Escribe un apellido y presiona Buscar.');
      log('BOOT OK');
    } catch (e) {
      err('boot() error', e.message);
      setStatus('No pude cargar el índice / generar manifest.');
    }
  }

  // ===== Eventos =====
  $q('#go').addEventListener('click', runSearch);
  $q('#q').addEventListener('keydown', e => { if (e.key === 'Enter') runSearch(); });

  // go!
  boot();
  </script>
</body>
</html>
