<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Apellidos - Chile</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
    .info {
      background: rgba(255,255,255,.9);
      padding: 8px 10px;
      border-radius: 6px;
      font-family: "Book Antiqua", serif;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // --- Utilidad para leer nombres con campos variables ---
    function getProp(props, keys, fallback = "—") {
      for (const k of keys) if (props && props[k] != null && props[k] !== "") return props[k];
      return fallback;
    }

    // --- Mapa base ---
    const map = L.map('map').setView([-35.6751, -71.5430], 5);

   // ---L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    // ---  attribution: '© OpenStreetMap contributors'
    // ---}).addTo(map);

    // --- Pane para asegurar orden de dibujo (comunas arriba) ---
    map.createPane('pane-provincias');  map.getPane('pane-provincias').style.zIndex = 520;
    map.createPane('pane-regiones');    map.getPane('pane-regiones').style.zIndex   = 530;
    map.createPane('pane-comunas');     map.getPane('pane-comunas').style.zIndex    = 650;

    // --- Controles de info ---
    const info = L.control({position: 'topright'});
    info.onAdd = function () { this._div = L.DomUtil.create('div','info'); this.update(); return this._div; };
    info.update = (txt) => this._div ? this._div.innerHTML = (txt || "<b>Mapa de Apellidos</b><br>Provincias en verde.<br>Acércate (zoom ≥ 7) para ver comunas en rojo.") : null;
    info.addTo(map);

    // --- Grupos de capas ---
    const provinciasLayer = L.layerGroup().addTo(map);
    const regionesLayer   = L.layerGroup();     // opcional
    const comunasLayer    = L.layerGroup();     // aparece con zoom
    let comunasGeoLayer = null;

    // --- Estilos ---
    const styleProvincias = { color:"#333", weight:1, fillColor:"#76c893", fillOpacity:.55 };
    const styleRegiones   = { color:"#1b4d3e", weight:2, fillOpacity:0, dashArray:"3" };
    const styleComunas    = { color:"#990000", weight:.8, fillColor:"#e34a33", fillOpacity:.45 };

    const BASE = "https://raw.githubusercontent.com/crcofre/mapa-apellidos/main";

    // --- Provincias (verde) ---
    fetch(`${BASE}/provincias.json`)
      .then(r => { if(!r.ok) throw new Error("provincias.json"); return r.json(); })
      .then(geo => L.geoJSON(geo, {
        pane: 'pane-provincias',
        style: styleProvincias,
        onEachFeature: (f, layer) => {
          const p = f.properties||{};
          const prov = getProp(p, ["PROVINCIA","NOM_PROV","Provincia","NAME_2","name"], "Provincia");
          const reg  = getProp(p, ["REGION","NOM_REG","Región","NAME_1"], "Región");
          layer.bindPopup(`<b>Provincia:</b> ${prov}<br><b>Región:</b> ${reg}`);
          layer.on('click', () => map.fitBounds(layer.getBounds(), {padding:[20,20]}));
        }
      }).addTo(provinciasLayer))
      .catch(e => console.warn("No se pudo cargar:", e.message));

    // --- Regiones (borde, opcional) ---
    fetch(`${BASE}/regiones.json`)
      .then(r => { if(!r.ok) throw new Error("regiones.json"); return r.json(); })
      .then(geo => L.geoJSON(geo, {
        pane: 'pane-regiones',
        style: styleRegiones,
        onEachFeature: (f, layer) => {
          const p = f.properties||{};
          const reg = getProp(p, ["REGION","NOM_REG","Región","NAME_1"], "Región");
          layer.bindPopup(`<b>Región:</b> ${reg}`);
        }
      }).addTo(regionesLayer))
      .catch(() => {}); // si no existe, no molesta

    // --- Comunas (rojo, solo con zoom) ---
    fetch(`${BASE}/comunas.json`)
      .then(r => { if(!r.ok) throw new Error("comunas.json"); return r.json(); })
      .then(geo => {
        comunasGeoLayer = L.geoJSON(geo, {
          pane: 'pane-comunas',
          style: styleComunas,
          onEachFeature: (f, layer) => {
            const p = f.properties||{};
            const com  = getProp(p, ["COMUNA","NOM_COM","Comuna","name"], "Comuna");
            const prov = getProp(p, ["PROVINCIA","NOM_PROV","Provincia","NAME_2"], "Provincia");
            const reg  = getProp(p, ["REGION","NOM_REG","Región","NAME_1"], "Región");
            layer.bindPopup(`<b>Comuna:</b> ${com}<br><b>Provincia:</b> ${prov}<br><b>Región:</b> ${reg}`);
            layer.on('click', () => map.fitBounds(layer.getBounds(), {padding:[20,20]}));
          }
        });
        updateComunasVisibility();
      })
      .catch(e => console.error("No se pudo cargar:", e.message));

    const ZOOM_MIN_COMUNAS = 7;
    function updateComunasVisibility() {
      if (!comunasGeoLayer) return;
      if (map.getZoom() >= ZOOM_MIN_COMUNAS) {
        if (!map.hasLayer(comunasLayer)) comunasLayer.addTo(map);
        if (!comunasLayer.hasLayer(comunasGeoLayer)) comunasGeoLayer.addTo(comunasLayer);
        info.update("<b>Mapa de Apellidos</b><br>Comunas visibles (rojo).");
      } else {
        if (comunasLayer.hasLayer(comunasGeoLayer)) comunasLayer.removeLayer(comunasGeoLayer);
        if (map.hasLayer(comunasLayer)) map.removeLayer(comunasLayer);
        info.update(); // texto por defecto
      }
    }
    map.on('zoomend', updateComunasVisibility);

    // --- Control de capas (opcional) ---
    L.control.layers(null, {
      "Provincias (verde)": provinciasLayer,
      "Regiones (borde)": regionesLayer,
      "Comunas (rojo, zoom≥7)": comunasLayer
    }, {collapsed:true}).addTo(map);
  </script>
</body>
</html>
