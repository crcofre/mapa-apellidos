<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Apellidos en Chile</title>

  <!-- Leaflet (por si tu código ya lo usa; si no lo necesitas, puedes quitarlo) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --card-bg: #fff;
      --border: #e7e7e7;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,.12);
      --pad: 10px;
      --text: #222;
      --muted: #6b7280;
      --brand: #2563eb;
    }

    html, body { height: 100%; margin: 0; color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .wrap { max-width: 1200px; margin: 16px auto; padding: 0 12px; }

    /* Panel superior (buscador) */
    .panel {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    #top-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    #search-panel label { display: block; font-weight: 700; margin-bottom: 6px; }
    #apellido-input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      outline: none;
    }
    #apellido-input:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(37, 99, 235, .15); }

    .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }

    /* Layout mapa + lateral derecho (leyenda) */
    #layout {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 12px;
    }
    @media (max-width: 980px) {
      #layout { grid-template-columns: 1fr; }
    }

    #map {
      width: 100%;
      height: 72vh;
      min-height: 420px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: #f8fafc;
    }

    /* Leyenda + nivel de visualización */
    #legend, .legend, .legend-panel {
      width: 100%;
      box-sizing: border-box;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      align-self: start;
    }

    #level-controls {
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin-bottom: 10px;
      background: #fff;
      width: 100%;
      font-size: .92rem;
    }
    #level-controls .title {
      font-weight: 700;
      margin-bottom: 6px;
    }
    #level-controls .row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px 12px;
    }
    #level-controls label {
      display: flex; align-items: center; gap: 6px; cursor: pointer;
      user-select: none;
    }
    #level-controls input[type="radio"] { accent-color: var(--brand); }

    /* Leyenda de frecuencia */
    #legend h3 { margin: 0 0 8px 0; font-size: 16px; }
    .scale { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .box { height: 18px; border-radius: 6px; border: 1px solid rgba(0,0,0,.08); }
    .lab { font-size: 12px; color: var(--muted); text-align: center; margin-top: 6px; }

    /* Ocultar controles de zoom y posibles overlays de LOGS */
    .leaflet-control-zoom,
    .mapboxgl-ctrl-zoom,
    .zoom-controls,
    #zoom-controls { display: none !important; }

    #logs, #log, .debug-log, .console-overlay { display: none !important; }

    /* Quitar outlines molestos en SVG, mantener accesibilidad del resto */
    svg:focus, svg *:focus, svg:focus-visible, svg *:focus-visible { outline: none !important; }

    /* Tooltip de estado bajo el buscador */
    #status-text { color: var(--muted); font-size: 13px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- BUSCADOR SIN BOTÓN (auto-ejecuta al escribir o elegir) -->
    <div id="top-grid">
      <div id="search-panel" class="panel">
        <label for="apellido-input">Consulta tu apellido</label>
        <!-- puede ser input text o select; el JS soporta ambos -->
        <input id="apellido-input" type="text" placeholder="Ej: PRIETO" autocomplete="off" />
        <!-- Si prefieres un <select>, reemplaza la línea anterior por:
        <select id="apellido-input">
          <option value="">Selecciona tu apellido…</option>
          <option>PRIETO</option>
          ...
        </select>
        -->
        <div id="status-text" class="hint">Escribe un apellido y el mapa se actualizará automáticamente.</div>
      </div>
    </div>

    <div id="layout">
      <div id="map"></div>

      <!-- LADO DERECHO: primero va Nivel de visualización, luego la LEYENDA -->
      <aside>
        <!-- Los radios los movemos arriba de la leyenda y con mismo ancho -->
        <div id="level-controls" style="display:none">
          <div class="title">Nivel de visualización</div>
          <div class="row">
            <label><input type="radio" name="nivel" value="auto"> Auto (según zoom)</label>
            <label><input type="radio" name="nivel" value="region"> Región</label>
            <label><input type="radio" name="nivel" value="provincia"> Provincia</label>
            <label><input type="radio" name="nivel" value="comuna" checked> Comuna</label>
          </div>
        </div>

        <div id="legend" class="legend-panel">
          <h3>Frecuencia</h3>
          <div class="scale">
            <div class="box" style="background:#fee5d9"></div>
            <div class="box" style="background:#fcae91"></div>
            <div class="box" style="background:#fb6a4a"></div>
            <div class="box" style="background:#de2d26"></div>
            <div class="box" style="background:#a50f15"></div>
          </div>
          <div class="scale" style="grid-template-columns: repeat(5, 1fr);">
            <div class="lab">Muy baja</div>
            <div class="lab">Baja</div>
            <div class="lab">Media</div>
            <div class="lab">Alta</div>
            <div class="lab">Muy alta</div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ===== 1) Silenciar logs en producción (no mostrar overlays ni console.*) =====
    (function(){
      const DEBUG = false;
      if (!DEBUG) {
        const noop = function(){};
        ["log","info","warn","debug","table"].forEach(fn => console[fn] = noop);
        ["logs","log"].forEach(id => { const el = document.getElementById(id); if (el) el.remove(); });
      }
    })();

    // ===== 2) Inicializar mapa base (si ya tienes uno, esto no molesta) =====
    (function initFallbackLeaflet(){
      if (!window.L) return;
      if (document.querySelector('.leaflet-container')) return; // ya existe
      const mapEl = document.getElementById('map');
      if (!mapEl) return;

      const map = L.map(mapEl, { zoomControl: false, attributionControl: false })
        .setView([-35.6751, -71.5430], 5); // Chile centro aprox

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 10
      }).addTo(map);

      // Exponer por si tu código lo quiere reutilizar
      window._leafletMap = map;
    })();

    // ===== 3) Reubicar "Nivel de visualización" arriba de la leyenda =====
    (function(){
      const level = document.getElementById('level-controls');
      const legend = document.getElementById('legend') || document.querySelector('.legend') || document.querySelector('.legend-panel');
      if (level && legend) {
        legend.parentNode.insertBefore(level, legend); // queda encima
        level.style.display = 'block';
        level.style.width = '100%';
      }
    })();

    // ===== 4) BÚSQUEDA AUTOMÁTICA SIN BOTÓN =====
    (function(){
      // Debounce utilitario
      function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), ms); }; }

      // Detectar input o select del apellido
      const input = document.getElementById('apellido-input') || document.getElementById('search-input') || document.querySelector('input[name="apellido"], select[name="apellido"]');
      if (!input) return;

      // Función que tu app ya debería tener (no rompemos tu lógica)
      async function cargarApellido(ap){
        if (!ap || !String(ap).trim()) return;
        const apellido = String(ap).trim().toUpperCase();

        // Llama a tu función real si existe
        if (typeof window.updateMapForSurname === 'function') {
          await window.updateMapForSurname(apellido);
        } else if (typeof window.loadSurname === 'function') {
          await window.loadSurname(apellido);
        } else {
          // Fallback: marcador simple para que no quede en blanco total
          if (window._leafletMap) {
            // sólo muestra un popup indicativo
            const m = L.marker([-33.45, -70.6667]).addTo(_leafletMap);
            m.bindPopup(`Mostrando "<b>${apellido}</b>" (conecta tu función updateMapForSurname).`).openPopup();
          }
        }

        const status = document.getElementById('status-text') || document.querySelector('.status-text');
        if (status) status.textContent = `Mostrando "${apellido}"`;
      }

      // Si es select, disparar en change; si es input text, en input con debounce
      const handler = debounce(() => cargarApellido(input.value), 250);
      input.addEventListener('change', ()=> cargarApellido(input.value));
      input.addEventListener('input', handler);

      // Cargar si ya viene con valor (por ejemplo, al abrir con ?q=PRIETO)
      const params = new URLSearchParams(location.search);
      const q = params.get('q');
      if (q && !input.value) input.value = q;
      if (input.value && input.value.trim()) cargarApellido(input.value);

      // Prevenir submit al presionar Enter
      input.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });
    })();

    // ===== 5) Desactivar y/o retirar controles de zoom si algún script los crea =====
    (function(){
      const killZoomUI = () => {
        document.querySelectorAll('.leaflet-control-zoom, .mapboxgl-ctrl-zoom, .zoom-controls, #zoom-controls')
          .forEach(n=> n.remove());
      };
      killZoomUI();
      const obs = new MutationObserver(killZoomUI);
      obs.observe(document.body, { childList: true, subtree: true });
    })();
  </script>
</body>
</html>
